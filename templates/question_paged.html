{% extends "base_public.html" %}
{% block title %}Questions{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">

  <!-- Header: name left, progress right -->
  <div class="flex items-center justify-between mb-3">
    <div class="text-sm text-gray-700 font-medium">{{ name }}</div>

    <div class="flex items-center gap-3">
      <div class="text-xs text-gray-600">Question {{ idx + 1 }} of {{ n }}</div>
      <div class="w-44 h-1.5 bg-gray-200 rounded-full overflow-hidden">
        <!-- progress_pct comes from the route; shows 0% on Q1 -->
        <div class="h-full bg-primary" style="width: {{ progress_pct }}%"></div>
      </div>
    </div>
  </div>

  <!-- Question card -->
  <div class="bg-white ring-1 ring-gray-200 rounded-xl p-5 mb-4">
    <div class="flex items-start justify-between">
      <div class="inline-flex items-center rounded-full bg-gray-100 text-gray-700 px-2 py-0.5 text-[11px]">
        Question {{ idx + 1 }}
      </div>
      <!-- Timer chip (moved here to match screenshot location) -->
      <span id="q-timer"
            class="inline-flex items-center rounded-md bg-gray-100 text-gray-700 px-2 py-0.5 text-[11px] select-none">0:00</span>
    </div>
    <p class="mt-2 text-gray-900 font-medium">
      {{ q }}
    </p>
  </div>

  <!-- Answer card -->
  <form method="post" class="bg-white ring-1 ring-gray-200 rounded-xl p-5">
    <label class="block text-sm font-medium text-gray-900 mb-2">Your Response</label>

	<input type="hidden" name="elapsed_ms" id="elapsed_ms" value="0">
	{# helps server if route doesn't carry index in the URL #}
	<input type="hidden" name="q_index" value="{{ idx }}">
	<!-- ET-7: Track paste events -->
	<input type="hidden" name="paste_detected" id="paste_detected" value="0">


    <textarea
      name="answer"
      id="answer-textarea"
      rows="12"
      maxlength="1000"
      class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm
             focus:outline-none focus:ring-2 focus:ring-primary/60"
      data-paste-ranges="[]"
    >{{ a }}</textarea>
    <!-- ET-7: Hidden field to store paste ranges -->
    <input type="hidden" name="paste_ranges" id="paste_ranges" value="[]">

    <div class="mt-2 flex items-center justify-between">
      <div class="text-xs text-gray-500">
        <span id="count">{{ a|length }}</span>/1000
      </div>

      <div class="flex gap-2">
        <!-- Use POST so the current answer is saved before navigating -->
        <button
          name="action"
          value="prev"
          type="submit"
          class="inline-flex items-center rounded-md border px-3 py-2 text-sm text-gray-700 hover:bg-gray-50
                 {% if idx == 0 %}opacity-50 cursor-not-allowed{% endif %}"
          {% if idx == 0 %}disabled{% endif %}
        >
          ← Previous
        </button>

        <button
          name="action"
          value="next"
          type="submit"
          class="inline-flex items-center rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-[#0b7c70]"
        >
          {% if idx + 1 < n %}Next Question →{% else %}Submit →{% endif %}
        </button>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block body_extra %}
<script>
// ET-7: Optimized timer (single script, no external dependencies)
(function() {
  const qIdx = {{ idx }};
  const cid = '{{ cid }}';
  const key = `qt_${cid}_${qIdx}`;
  
  let start = Date.now();
  let prev = parseInt(sessionStorage.getItem(key) || '0');
  let iv;
  
  function update() {
    const chip = document.getElementById('q-timer');
    if (!chip) return;
    const t = prev + Date.now() - start;
    const s = Math.floor(t / 1000);
    chip.textContent = `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
  }
  
  iv = setInterval(update, 1000);
  update();
  
  document.querySelector('form').addEventListener('submit', function() {
    clearInterval(iv);
    const elapsed = Date.now() - start;
    const total = prev + elapsed;
    sessionStorage.setItem(key, total);
    document.getElementById('elapsed_ms').value = elapsed;
  });
  
  window.addEventListener('beforeunload', () => sessionStorage.setItem(key, prev + Date.now() - start));
})();

// ET-7: Paste tracking (optimized)
(function() {
  const ta = document.getElementById('answer-textarea');
  const pd = document.getElementById('paste_detected');
  const pr = document.getElementById('paste_ranges');
  let ranges = [];
  
  ta.addEventListener('paste', function() {
    pd.value = '1';
    const start = ta.selectionStart;
    setTimeout(() => {
      const len = ta.selectionEnd - start;
      if (len > 0) {
        ranges.push({start, end: start + len, length: len});
        pr.value = JSON.stringify(ranges);
      }
    }, 10);
  });
  
  // Character counter
  const counter = document.getElementById('count');
  ta.addEventListener('input', () => {
    const len = ta.value.length;
    counter.textContent = len;
    const parent = counter.parentElement;
    parent.className = len > 900 ? 'text-xs text-amber-600' : len > 800 ? 'text-xs text-yellow-600' : 'text-xs text-gray-500';
  });
})();

// ET-7: Tab switch detection
(function() {
  const url = "{{ url_for('flag_tab_switch', tenant=tenant_slug, code=code, cid=cid) }}";
  let internal = false;
  
  document.querySelector('form').addEventListener('submit', () => internal = true, {capture: true});
  
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && !internal && document.visibilityState === 'hidden') {
      try { navigator.sendBeacon(url); } catch { fetch(url, {method: 'POST', keepalive: true}); }
    }
  });
  
  window.addEventListener('pagehide', () => {
    if (!internal) {
      try { navigator.sendBeacon(url); } catch {}
    }
  });
})();
</script>
{% endblock %}
