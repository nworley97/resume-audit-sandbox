{% extends "base_app.html" %}
{% block title %}Job Posting - ALTERA{% endblock %}

{% block content %}

<!-- Small breadcrumb label with grid icon -->
<div class="flex items-center gap-2 text-slate text-sm mb-2">
  <!-- grid-4 icon -->
  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
    <rect x="3"  y="3"  width="7" height="7" rx="1.5"></rect>
    <rect x="14" y="3"  width="7" height="7" rx="1.5"></rect>
    <rect x="3"  y="14" width="7" height="7" rx="1.5"></rect>
    <rect x="14" y="14" width="7" height="7" rx="1.5"></rect>
  </svg>
  <span>Job Posting</span>
</div>

<!-- Big page title -->
<h1 class="text-2xl font-semibold text-title mb-1">Job Posting</h1>
<p class="text-slate mb-6">Manage and track your job postings</p>

<!-- Action bar sits outside the card (Create, Filter, Export in card header in figma) -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200">
  <!-- Card header: Search + actions -->
  <div class="flex items-center justify-between gap-3 p-4 border-b border-gray-200">
    <!-- Search -->
    <form
      action="{{ url_for('recruiter', tenant=tenant.slug if tenant else None) }}"
      method="get"
      class="w-full max-w-md"
    >
      <input
        type="hidden" name="status" value="{{ status or '' }}">
      <input
        type="hidden" name="sort" value="{{ sort or '' }}">
      <input
        type="hidden" name="dir" value="{{ dir or '' }}">
      <div class="relative">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate/70">
          <!-- search icon -->
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M20 20L17 17"></path>
          </svg>
        </span>
        <input
          class="w-full rounded-lg border border-gray-300 pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
          type="text"
          name="q"
          value="{{ q }}"
          placeholder="Search by Job Title or ID"
        />
      </div>
    </form>

    <!-- Right actions -->
    <div class="flex items-center gap-2">
      <a
        href="{{ url_for('edit_job', tenant=tenant.slug if tenant else None) }}"
        class="inline-flex items-center gap-2 rounded-lg bg-primary text-white text-sm font-medium px-3 py-2 hover:opacity-95"
      >
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
        </svg>
        Create Job
      </a>

      <!-- Filter (placeholder link, wire later if you need) -->
      <a href="{{ url_for('recruiter', tenant=tenant.slug if tenant else None, q=q, status=status, sort=sort, dir=dir) }}"
         class="inline-flex items-center gap-2 rounded-lg border border-gray-300 text-sm px-3 py-2 hover:bg-gray-50">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M3 5h18M6 12h12M10 19h4" stroke-linecap="round"/>
        </svg>
        Filter
      </a>

      <!-- Export CSV -->
      <a href="{{ url_for('export_jobs', tenant=tenant.slug if tenant else None, q=q, status=status, sort=sort, dir=dir) }}"
         class="inline-flex items-center gap-2 rounded-lg border border-gray-300 text-sm px-3 py-2 hover:bg-gray-50">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M12 3v12M7 10l5 5 5-5" stroke-linecap="round" stroke-linejoin="round"/>
          <rect x="4" y="17" width="16" height="4" rx="1.5"></rect>
        </svg>
        Export
      </a>
    </div>
  </div>

  <!-- Counts line -->
  <div class="px-4 py-3 text-sm text-title/80">
    {{ status_counts.open or 0 }} Open
    <span class="mx-1 text-slate/40">•</span>
    {{ status_counts.pending or 0 }} Pending
    <span class="mx-1 text-slate/40">•</span>
    {{ status_counts.draft or 0 }} Draft
  </div>

  <!-- Table -->
  <div class="px-2 pb-2">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-slate border-y border-gray-200">
            <th class="text-left font-medium py-3 pl-4 w-10">
              <input type="checkbox" class="rounded border-gray-300">
            </th>

            {% macro sort_header(label, key, width='') -%}
              {# highlight current sort #}
              {% set active = (sort==key) %}
              {% set is_asc = (active and dir=='asc') %}
              {% set is_desc = (active and dir=='desc') %}
              <th class="text-left font-medium py-3 {{ width }}">
                <div class="inline-flex items-center gap-1">
                  <span>{{ label }}</span>
                  <span class="flex flex-col leading-none">
                    <a title="Sort ascending"
                       class="h-2 {{ 'text-title' if is_asc else 'text-slate/40' }}"
                       href="{{ url_for('recruiter',
                          tenant=tenant.slug if tenant else None,
                          q=q, status=status, page=1, per_page=pagination.per_page,
                          sort=key, dir='asc') }}">
                      <!-- chevron up -->
                      <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path d="M6 14l6-6 6 6" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </a>
                    <a title="Sort descending"
                       class="h-2 {{ 'text-title' if is_desc else 'text-slate/40' }}"
                       href="{{ url_for('recruiter',
                          tenant=tenant.slug if tenant else None,
                          q=q, status=status, page=1, per_page=pagination.per_page,
                          sort=key, dir='desc') }}">
                      <!-- chevron down -->
                      <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path d="M6 10l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </a>
                  </span>
                </div>
              </th>
            {%- endmacro %}

            {{ sort_header('Job ID', 'job_id', 'w-32') }}
            {{ sort_header('Job Title', 'job_title') }}
            {{ sort_header('Department', 'department', 'w-44') }}
            {{ sort_header('Start Date', 'start_date', 'w-36') }}
            {{ sort_header('End Date', 'end_date', 'w-36') }}
            {{ sort_header('Status', 'status', 'w-28') }}

            <th class="text-left font-medium py-3 pr-4 w-56">View Candidates</th>
          </tr>
        </thead>

        <tbody>
          {% for jd in page_items %}
          <tr class="border-t border-gray-200 hover:bg-gray-50/60">
            <td class="py-3 pl-4">
              <input type="checkbox" class="rounded border-gray-300">
            </td>
            <td class="py-3">{{ jd.code or '' }}</td>
            <td class="py-3">{{ jd.title or '' }}</td>
            <td class="py-3">{{ jd.department or '' }}</td>
            <td class="py-3">
              {% set sd = jd.start_date %}
              {{ sd.strftime('%b %d, %Y') if sd else '' }}
            </td>
            <td class="py-3">
              {% set ed = jd.end_date %}
              {{ ed.strftime('%b %d, %Y') if ed else '' }}
            </td>
            <td class="py-3">
              {% set st = (jd.status or '')|lower %}
              {% set chip = {
                'open':    'bg-blue-100 text-blue-700',
                'pending': 'bg-gray-100 text-gray-700',
                'draft':   'bg-yellow-100 text-yellow-700',
                'closed':  'bg-rose-100 text-rose-700'
              } %}
              <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium {{ chip.get(st, 'bg-gray-100 text-slate-700') }}">
                {{ (jd.status or '')|capitalize }}
              </span>
            </td>

            <!-- View candidates: initials bubbles + "+N" and button -->
            <td class="py-3 pr-4">
              <div class="flex items-center gap-3">
                <div class="flex -space-x-2">
                  {% for ini in (cand_peeks.get(jd.code, []) or []) %}
                    <div class="w-6 h-6 rounded-full bg-slate-900 text-white text-[10px] flex items-center justify-center ring-2 ring-white">
                      {{ ini }}
                    </div>
                  {% endfor %}
                  {% if (cand_more.get(jd.code, 0) or 0) > 0 %}
                    <div class="w-6 h-6 rounded-full bg-gray-100 text-title text-[10px] flex items-center justify-center ring-2 ring-white">
                      +{{ cand_more.get(jd.code) }}
                    </div>
                  {% endif %}
                </div>

                <a href="{{ url_for('view_candidates', tenant=tenant.slug if tenant else None, code=jd.code) }}"
                   class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-2.5 py-1.5 text-xs hover:bg-gray-50">
                  View Candidates
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between px-2 py-4">
      <div class="text-sm text-slate">
        <span class="inline-flex items-center gap-1">
          <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M10 19l-7-7 7-7M3 12h18" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Previous
        </span>
      </div>

      <div class="flex items-center gap-1">
        {% for p in pagination.window %}
          {% if p == '…' %}
            <span class="px-2 text-slate">…</span>
          {% else %}
            <a href="{{ url_for('recruiter',
                                tenant=tenant.slug if tenant else None,
                                q=q, status=status, sort=sort, dir=dir,
                                page=p, per_page=pagination.per_page) }}"
               class="min-w-[2rem] text-center rounded-md px-2 py-1 text-sm {{ 'bg-gray-900 text-white' if p==pagination.page else 'hover:bg-gray-100 text-title' }}">
              {{ p }}
            </a>
          {% endif %}
        {% endfor %}
      </div>

      <div class="text-sm text-slate">
        <span class="inline-flex items-center gap-1">
          Next
          <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M14 5l7 7-7 7M3 12h18" stroke-linecap="round" stroke-linejoin="round"/>
          </svg> 
        </span>
      </div>
    </div>
  </div>
</div>

{% endblock %}
