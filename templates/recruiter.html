{% extends "base_app.html" %}
{% block title %}Recruiter - ALTERA{% endblock %}
{% block content %}

<!-- Top breadcrumb (optional) -->
<div class="text-xs text-slate mb-4">Job Posting</div>

<!-- Page title + actions -->
<div class="flex items-start justify-between mb-4">
  <div>
    <h1 class="text-xl font-semibold">Job Posting</h1>
    <p class="text-sm text-slate mt-1">Manage and track your job postings</p>
  </div>

  <div class="flex items-center gap-2">
    <a href="{{ url_for('edit_jd', tenant=tenant.slug) if tenant else url_for('edit_jd') }}"
       class="inline-flex items-center gap-2 rounded-lg bg-[#085CFF] text-white text-sm font-medium px-3.5 py-2 hover:brightness-95 transition">
      <!-- plus icon -->
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14"/>
      </svg>
      Create Job
    </a>

    <!-- Filter (simple dropdown via <details>) -->
    <details class="relative">
      <summary class="list-none inline-flex items-center gap-2 rounded-lg border border-gray-300 text-sm text-title px-3.5 py-2 cursor-pointer hover:bg-gray-50">
        <!-- funnel icon -->
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M3 4h18M6 8h12M9 12h6M10 16h4M11 20h2"/>
        </svg>
        Filter
      </summary>
      <div class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow z-10">
        {% set base_qs = request.query_string.decode() %}
        <a class="block px-3 py-2 text-sm hover:bg-gray-50" href="{{ url_for('recruiter', tenant=tenant.slug) if tenant else url_for('recruiter') }}">All</a>
        <a class="block px-3 py-2 text-sm hover:bg-gray-50" href="{{ url_for('recruiter', tenant=tenant.slug, status='open', q=request.args.get('q','')) if tenant else url_for('recruiter', status='open', q=request.args.get('q','')) }}">Open</a>
        <a class="block px-3 py-2 text-sm hover:bg-gray-50" href="{{ url_for('recruiter', tenant=tenant.slug, status='pending', q=request.args.get('q','')) if tenant else url_for('recruiter', status='pending', q=request.args.get('q','')) }}">Pending</a>
        <a class="block px-3 py-2 text-sm hover:bg-gray-50" href="{{ url_for('recruiter', tenant=tenant.slug, status='draft', q=request.args.get('q','')) if tenant else url_for('recruiter', status='draft', q=request.args.get('q','')) }}">Draft</a>
        <a class="block px-3 py-2 text-sm hover:bg-gray-50" href="{{ url_for('recruiter', tenant=tenant.slug, status='closed', q=request.args.get('q','')) if tenant else url_for('recruiter', status='closed', q=request.args.get('q','')) }}">Closed</a>
      </div>
    </details>

    <!-- Export CSV -->
    <a href="{{ url_for('export_jobs', tenant=tenant.slug, q=request.args.get('q',''), status=request.args.get('status'), page=request.args.get('page',1), per_page=request.args.get('per_page',10)) if tenant else url_for('export_jobs', q=request.args.get('q',''), status=request.args.get('status'), page=request.args.get('page',1), per_page=request.args.get('per_page',10)) }}"
       class="inline-flex items-center gap-2 rounded-lg border border-gray-300 text-sm text-title px-3.5 py-2 hover:bg-gray-50">
      <!-- arrow-down-tray icon -->
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16v2a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-2M12 12v-8m0 8l-3-3m3 3 3-3"/>
      </svg>
      Export
    </a>
  </div>
</div>

<!-- Search -->
<form method="get" class="mb-4">
  {% if tenant %}<input type="hidden" name="tenant" value="{{ tenant.slug }}">{% endif %}
  {% if request.args.get('status') %}<input type="hidden" name="status" value="{{ request.args.get('status') }}">{% endif %}
  <div class="relative max-w-md">
    <input name="q" value="{{ request.args.get('q','') }}"
           placeholder="Search by Job Title or ID"
           class="w-full rounded-lg border border-gray-300 pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#085CFF]">
    <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/>
    </svg>
  </div>
</form>

<!-- Jobs table -->
<div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
  <table class="min-w-full divide-y divide-gray-200 text-sm">
    <thead class="bg-gray-50">
      <tr class="text-left text-slate">
        <th class="px-4 py-3 font-medium">Job ID</th>
        <th class="px-4 py-3 font-medium">Job Title</th>
        <th class="px-4 py-3 font-medium">Department</th>
        <th class="px-4 py-3 font-medium">Start Date</th>
        <th class="px-4 py-3 font-medium">End Date</th>
        <th class="px-4 py-3 font-medium">Status</th>
        <th class="px-4 py-3 font-medium">View Candidates</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      {% if page_items %}
        {% for jd in page_items %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-title whitespace-nowrap">{{ jd.code }}</td>
          <td class="px-4 py-3 text-title">{{ jd.title }}</td>
          <td class="px-4 py-3">{{ jd.department or '' }}</td>
          <td class="px-4 py-3">
            {% set sd = jd.start_date if jd is not none else None %}
            {{ sd.strftime('%b %d, %Y') if sd else '' }}
          </td>
          <td class="px-4 py-3">
            {% set ed = jd.end_date if jd is not none else None %}
            {{ ed.strftime('%b %d, %Y') if ed else '' }}
          </td>
          <td class="px-4 py-3">
            {% set status = (jd.status or 'draft')|lower %}
            {% if status == 'open' %}
              <span class="inline-flex items-center rounded-full bg-green-50 text-green-700 border border-green-200 px-2.5 py-0.5 text-xs font-medium">Open</span>
            {% elif status == 'pending' %}
              <span class="inline-flex items-center rounded-full bg-amber-50 text-amber-700 border border-amber-200 px-2.5 py-0.5 text-xs font-medium">Pending</span>
            {% elif status == 'closed' %}
              <span class="inline-flex items-center rounded-full bg-gray-100 text-gray-700 border border-gray-200 px-2.5 py-0.5 text-xs font-medium">Closed</span>
            {% else %}
              <span class="inline-flex items-center rounded-full bg-yellow-50 text-yellow-800 border border-yellow-200 px-2.5 py-0.5 text-xs font-medium">Draft</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center rounded-md bg-blue-50 text-[#085CFF] border border-blue-100 px-2.5 py-0.5 text-xs font-semibold">
                {{ counts[jd.code] if counts and jd.code in counts else 0 }}
              </span>
              <a href="{{ url_for('view_candidates', code=jd.code, tenant=tenant.slug) if tenant else url_for('view_candidates', code=jd.code) }}"
                 class="inline-flex items-center rounded-md border border-gray-300 px-3 py-1.5 text-xs font-medium text-slate hover:bg-gray-50">
                View Candidates
              </a>
            </div>
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" class="px-4 py-6 text-center text-slate">No job postings yet</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
  <div class="mt-4 flex items-center justify-between text-sm">
    <a class="px-3 py-1 rounded border border-gray-300 text-slate hover:bg-gray-50 {{ 'pointer-events-none opacity-50' if pagination.page <= 1 }}"
       href="{{ url_for('recruiter', tenant=tenant.slug, q=request.args.get('q',''), status=request.args.get('status'), page=pagination.page-1, per_page=pagination.per_page) if tenant else url_for('recruiter', q=request.args.get('q',''), status=request.args.get('status'), page=pagination.page-1, per_page=pagination.per_page) }}">
      ← Previous
    </a>
    <div class="flex items-center gap-1">
      {% for p in pagination.window %}
        {% if p == '…' %}
          <span class="px-2 text-slate">…</span>
        {% elif p == pagination.page %}
          <span class="px-3 py-1 rounded bg-gray-900 text-white">{{ p }}</span>
        {% else %}
          <a class="px-3 py-1 rounded border border-gray-300 hover:bg-gray-50"
             href="{{ url_for('recruiter', tenant=tenant.slug, q=request.args.get('q',''), status=request.args.get('status'), page=p, per_page=pagination.per_page) if tenant else url_for('recruiter', q=request.args.get('q',''), status=request.args.get('status'), page=p, per_page=pagination.per_page) }}">{{ p }}</a>
        {% endif %}
      {% endfor %}
    </div>
    <a class="px-3 py-1 rounded border border-gray-300 text-slate hover:bg-gray-50 {{ 'pointer-events-none opacity-50' if pagination.page >= pagination.pages }}"
       href="{{ url_for('recruiter', tenant=tenant.slug, q=request.args.get('q',''), status=request.args.get('status'), page=pagination.page+1, per_page=pagination.per_page) if tenant else url_for('recruiter', q=request.args.get('q',''), status=request.args.get('status'), page=pagination.page+1, per_page=pagination.per_page) }}">
      Next →
    </a>
  </div>
{% endif %}

{% endblock %}
