{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">All Candidates</h3>

<form class="row g-2 align-items-end mb-3" method="get">
  <div class="col-md-4">
    <label class="form-label">Search</label>
    <input name="q" value="{{ q }}" class="form-control" placeholder="Search name or ID">
  </div>
  <div class="col-md-4">
    <label class="form-label">Job Posting</label>
    <select name="jd" class="form-select">
      <option value="">All postings</option>
      {% for item in jd_list %}
        <option value="{{ item.code }}" {% if jd == item.code %}selected{% endif %}>
          {{ item.code }} — {{ item.title }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <button class="btn btn-primary w-100">Filter</button>
  </div>

{% set export_base = url_for('candidates_export_csv') %}
<!-- add a tiny left margin so it doesn't touch the Filter button -->
<div class="export-group d-inline-flex align-items-center gap-2 ms-2">
  <a class="btn btn-outline-secondary text-nowrap"
     href="{{ export_base }}{% if q or jd %}?{% endif %}{% if q %}q={{ q|urlencode }}{% endif %}{% if q and jd %}&{% endif %}{% if jd %}jd={{ jd|urlencode }}{% endif %}">
    Export Current View
  </a>
  <a class="btn btn-outline-secondary text-nowrap" href="{{ export_base }}?all=1">
    Export All
  </a>
</div>

</form>

<div class="mb-2 small text-muted">
  <strong>Legend:</strong>
  <span class="badge badge-score badge-green">≥ 4</span> Good
  <span class="badge badge-score badge-yellow">≥ 3</span> Medium
  <span class="badge badge-score badge-red">&lt; 3</span> Low
  <span class="ms-3">Showing {{ apps|length }} results</span>
</div>

<div class="card p-0">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width: 110px;">ID</th>
          <th style="width: 220px;">Name</th>
          <th style="width: 260px;">Email</th>
          <th style="width: 140px;">Job</th>
          <th style="width: 100px;">Fit</th>
          <th style="width: 130px;">Claim Avg</th>
          <th style="width: 180px;">Created</th>
          <th class="text-end" style="width: 160px;">Actions</th>
        </tr>
      </thead>
      <tbody>
      {% if apps and apps|length > 0 %}
        {% for c in apps %}
          {% set r = c.resume_json or {} %}
          {% set email = r.get('applicant_email') %}
          {% set fit_class = 'badge-green' if c.fit_score and c.fit_score >= 4
                             else ('badge-yellow' if c.fit_score and c.fit_score >= 3 else 'badge-red') %}
          {% set avgv = (c.answer_scores|sum / (c.answer_scores|length))|round(2)
                        if c.answer_scores and (c.answer_scores|length) > 0 else None %}
          {% set avg_class = 'badge-green' if avgv and avgv >= 4
                             else ('badge-yellow' if avgv and avgv >= 3 else 'badge-red') %}
          <tr>
            <td class="font-monospace">{{ c.id }}</td>
            <td>{{ c.name }}</td>
            <td>{{ email or '—' }}</td>
            <td>
				{% if c.jd_code %}
					<a href="{{ url_for('view_candidates', code=c.jd_code) }}" class="text-decoration-none">
						{{ c.jd_code }}
					</a>
				{% else %}—{% endif %}
			</td>

            <td>
              {% if c.fit_score is not none %}
                <span class="badge badge-score {{ fit_class }}">{{ c.fit_score }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if avgv is not none %}
                <span class="badge badge-score {{ avg_class }}">{{ avgv }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if c.created_at %}
                {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('detail', cid=c.id) }}">View</a>
              <a class="btn btn-sm btn-outline-danger"
                 href="{{ url_for('delete_candidate', cid=c.id) }}"
                 onclick="return confirm('Delete this application?');">Delete</a>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="8" class="text-center text-muted py-5">No candidates found.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
