{% extends "base_app.html" %}
{% block title %}Job Posting - ALTERA{% endblock %}

{% block content %}
<div class="space-y-6">

  <!-- Page header: title + status/app cards -->
  <div class="flex items-start justify-between">
    <div>
      <div class="flex items-center gap-2 text-slate text-sm mb-1">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
          <path d="M12 3l9 4-9 4-9-4 9-4Z"></path><path d="M21 12l-9 4-9-4"></path><path d="M21 17l-9 4-9-4"></path>
        </svg>
        <span>Job Posting</span>
      </div>
      <h1 class="text-2xl font-semibold text-title">Job Posting</h1>
      <p class="text-slate mt-1">Manage and track your job postings</p>
    </div>

    <div class="flex items-center gap-3">
      <!-- Job Status card -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 w-36 text-center">
        <div class="text-[11px] text-gray-500">Job Status</div>
        <div class="mt-1 inline-flex items-center justify-center rounded-md px-2.5 py-0.5 text-[11px] font-medium
          {% if jd and jd.is_published %} bg-emerald-100 text-emerald-700 {% else %} bg-amber-100 text-amber-700 {% endif %}">
          {{ 'Published' if jd and jd.is_published else 'Draft' }}
        </div>
      </div>

      <!-- Application (applicant count) -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 w-36 text-center">
        <div class="text-[11px] text-gray-500">Application</div>
        <div class="mt-1 text-sm font-semibold text-title">{{ applicant_count or 0 }}</div>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form method="post"
        action="{{ url_for('edit_jd', tenant=tenant_slug, code=jd.code) if jd and jd.code else url_for('edit_jd', tenant=tenant_slug) }}"
        class="space-y-6">
    <input type="hidden" name="jd_status" id="jd_status" value="{{ jd.status or 'draft' }}">

    <!-- Basic Information card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <h2 class="text-lg font-semibold text-title mb-4">Basic Information</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Job Title (required) -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">
            Job Title <span class="text-red-500">*</span>
          </label>
          <input name="jd_title" value="{{ jd.title or '' }}" required
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Job ID -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">Job ID</label>
          <input name="jd_code" value="{{ jd.jd_id or jd.code or '' }}" required
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Department / Team -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">Department / Team</label>
          <input name="jd_department" value="{{ jd.department or '' }}"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Location (required) -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">
            Location <span class="text-red-500">*</span>
          </label>
          <input name="location" value="{{ jd.location or '' }}" required
                 placeholder="e.g., San Francisco, CA (Remote)"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Start date/time (required date) -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-700 mb-1">
              Start Date <span class="text-red-500">*</span>
            </label>
            <input type="date" name="start_date" value="{{ jd.start_date or '' }}" required
                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">Start Time</label>
            <input type="time" name="start_time" value="{{ jd.start_time or '' }}"
                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
        </div>

        <!-- End date/time (required date) -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-700 mb-1">
              End Date <span class="text-red-500">*</span>
            </label>
            <input type="date" name="end_date" value="{{ jd.end_date or '' }}" required
                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">End Time</label>
            <input type="time" name="end_time" value="{{ jd.end_time or '' }}"
                   class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
        </div>

        <!-- Employment Type (required) -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">
            Employment Type <span class="text-red-500">*</span>
          </label>
          <input name="employment_type" value="{{ jd.employment_type or '' }}" required
                 placeholder="e.g., Full-time"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Work Arrangement -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">Work Arrangement</label>
          <input name="work_arrangement" value="{{ jd.work_arrangement or '' }}"
                 placeholder="Onsite / Hybrid / Remote"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Salary Range -->
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">Salary Range</label>
          <input name="salary_range" value="{{ jd.salary_range or '' }}" placeholder="e.g., $90,000 â€“ $120,000 annually"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>
      </div>

      <!-- Role description -->
      <div class="mt-4">
        <label class="block text-sm text-gray-700 mb-1">Role Description</label>
        <textarea name="jd_text" rows="7"
                  class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">{{ (jd.description or jd.html or '')|jd_plaintext }}</textarea>
        <!-- #hotfix/ABI-31: show sanitized HTML as readable text -->
      </div>
    </div>

    <!-- Self-identification survey -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <h2 class="text-lg font-semibold text-title mb-3">Self-Identification Survey</h2>

      <!-- tiny fallback so the knob slides even if Tailwind misses peer-checked -->
      <style>
        input.peer:checked + span > span { transform: translateX(1rem); }
        input.peer:checked + span { background: rgb(59 130 246); }
      </style>

      <label class="inline-flex items-center gap-2 cursor-pointer">
        <input type="checkbox" name="id_surveys_enabled" value="1"
               class="sr-only peer"
               {% if jd and jd.id_surveys_enabled %}checked{% endif %}>

        <span class="relative inline-block w-9 h-5 bg-gray-200 rounded-full transition
                     peer-checked:bg-blue-500">
          <span class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow transform transition
                       peer-checked:translate-x-4"></span>
        </span>

        <span class="text-sm text-gray-700">Enable self-identification survey</span>
      </label>
    </div>

    <!-- Question Settings (own card) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-lg font-semibold text-title">Question Settings</h2>
          <p class="text-sm text-gray-500 mt-1">
            Customize how many screening questions will be asked for this role.
          </p>
        </div>
      </div>

      <div class="mt-4 max-w-xs">
        <label class="block text-sm text-gray-700 mb-1">Number of Questions</label>
        <select name="question_count"
                class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
          {% set qc = (jd.questions_count if jd and jd.questions_count is not none else 3) %}
          {% for n in [1,2,3,4,5] %}
          <option value="{{ n }}" {% if qc==n %}selected{% endif %}>{{ n }} question{{ '' if n==1 else 's' }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Application Link (Figma-style) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <h2 class="text-lg font-semibold text-title">Application Link</h2>
      <p class="text-sm text-gray-500 mt-1">
        Once you publish this job posting, candidates will be able to apply using the link below.
        Share this link on your website, social media, or job boards.
      </p>

      <div class="mt-3 flex items-center gap-2 max-w-2xl">
        <input id="applyLink" readonly
               value="{{ apply_url or '' }}"
               class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm bg-gray-50 select-all" />
        <button type="button" id="copyBtn"
                class="inline-flex items-center rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">
          Copy
        </button>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-end gap-2">
      {# Delete: server enforces "no delete if applicants exist" #}
      <a href="{{ url_for('delete_jd', tenant=tenant_slug, code=jd.code) }}"
         class="rounded-lg border px-3 py-2 text-sm
                {{ '' if not has_candidates else 'pointer-events-none opacity-50' }}"
         onclick="return confirm('Delete this job?');">
        Delete
      </a>
      {% if has_candidates %}
        <span class="ml-2 text-xs text-gray-500 align-middle">Disabled: job has applicants</span>
      {% endif %}

      {# Close = simple link back (no post) #}
      <a href="{{ url_for('recruiter', tenant=tenant_slug) }}"
         data-noload
         class="rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">Close</a>

      {# Save as Draft (sets status) #}
      <button type="submit"
              onclick="document.getElementById('jd_status').value='draft'"
              class="rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">
        Save as Draft
      </button>

      {# Publish (sets status to open) #}
      <button type="submit"
              onclick="document.getElementById('jd_status').value='open'"
              class="rounded-lg bg-blue-600 text-white px-3 py-2 text-sm hover:bg-blue-700">
        Publish Job
      </button>
    </div>

  </form>
</div>

<script>
// Copy application link
const copyBtn = document.getElementById('copyBtn');
if (copyBtn) {
  copyBtn.addEventListener('click', async () => {
    const el = document.getElementById('applyLink');
    try { await navigator.clipboard.writeText(el.value || ''); copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent='Copy', 1400); }
    catch { el.select(); document.execCommand('copy'); copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent='Copy', 1400); }
  });
}
</script>
{% endblock %}
