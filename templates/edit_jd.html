{% extends "base_app.html" %}
{% block title %}Job Posting - ALTERA{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
<style>
          /* ET-12: Customize EasyMDE markdown editor styling */
  /* Override heading sizes to be more reasonable */
  .EasyMDEContainer .CodeMirror,
  .EasyMDEContainer .CodeMirror-scroll {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    color: #475569; /* slate-600 - softer tone */
  }
  
  .EasyMDEContainer .cm-header-1 {
    font-size: 1.5rem; /* 24px instead of default larger size */
    font-weight: 600;
    color: #334155; /* slate-700 */
    font-family: 'Inter', sans-serif;
  }
  
  .EasyMDEContainer .cm-header-2 {
    font-size: 1.25rem; /* 20px */
    font-weight: 600;
    color: #475569; /* slate-600 */
    font-family: 'Inter', sans-serif;
  }
  
  .EasyMDEContainer .cm-header-3 {
    font-size: 1.125rem; /* 18px */
    font-weight: 600;
    color: #64748b; /* slate-500 */
    font-family: 'Inter', sans-serif;
  }
  
  .EasyMDEContainer .cm-header-4,
  .EasyMDEContainer .cm-header-5,
  .EasyMDEContainer .cm-header-6 {
    font-size: 1rem; /* 16px */
    font-weight: 500;
    color: #64748b; /* slate-500 */
    font-family: 'Inter', sans-serif;
  }
  
  /* Preview mode headings */
  .editor-preview h1 {
    font-size: 1.5rem !important;
    font-weight: 600;
    color: #334155;
    font-family: 'Inter', sans-serif;
  }
  
  .editor-preview h2 {
    font-size: 1.25rem !important;
    font-weight: 600;
    color: #475569;
    font-family: 'Inter', sans-serif;
  }
  
  .editor-preview h3 {
    font-size: 1.125rem !important;
    font-weight: 600;
    color: #64748b;
    font-family: 'Inter', sans-serif;
  }
  
  .editor-preview h4,
  .editor-preview h5,
  .editor-preview h6 {
    font-size: 1rem !important;
    font-weight: 500;
    color: #64748b;
    font-family: 'Inter', sans-serif;
  }
  
  .editor-preview p,
  .editor-preview li {
    font-family: 'Inter', sans-serif;
    color: #475569;
  }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">

  <!-- Page header: title + status/app cards -->
  <div class="flex items-start justify-between">
    <div>
      <div class="flex items-center gap-2 text-slate text-sm mb-1">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
          <path d="M12 3l9 4-9 4-9-4 9-4Z"></path><path d="M21 12l-9 4-9-4"></path><path d="M21 17l-9 4-9-4"></path>
        </svg>
        <span>Job Posting</span>
      </div>
      <h1 class="text-2xl font-semibold text-title">Job Posting</h1>
      <p class="text-slate mt-1">Manage and track your job postings</p>
    </div>

    <div class="flex items-center gap-3">
      <!-- Job Status card -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 w-36 text-center">
        <div class="text-[11px] text-gray-500">Job Status</div>
        {% set status = (jd.status or 'draft')|lower %}
        {% set status_chip = {
          'open': 'bg-sky-100 text-sky-700',
          'published': 'bg-emerald-100 text-emerald-700',
          'closed': 'bg-rose-100 text-rose-700',
          'pending': 'bg-gray-100 text-gray-700',
          'draft': 'bg-amber-100 text-amber-700'
        } %}
        <div class="mt-1 inline-flex items-center justify-center rounded-md px-2.5 py-0.5 text-[11px] font-medium {{ status_chip.get(status, 'bg-amber-100 text-amber-700') }}">
          {{ status|capitalize }}
        </div>
      </div>

      <!-- Application (applicant count) -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 w-36 text-center">
        <div class="text-[11px] text-gray-500">Application</div>
        <div class="mt-1 text-sm font-semibold text-title">{{ applicant_count or 0 }}</div>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form method="post"
        action="{{ url_for('edit_jd', tenant=tenant_slug, code=jd.code) if jd and jd.code else url_for('edit_jd', tenant=tenant_slug) }}"
        class="space-y-6">
    <input type="hidden" name="jd_status" id="jd_status" value="{{ jd.status or 'draft' }}">

    <!-- Basic Information card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <h2 class="text-xl font-semibold text-title mb-4" style="font-family: 'Poppins', sans-serif;">Basic Information</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Job Title (required) -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">
            Job Title <span class="text-red-500">*</span>
          </label>
          <input name="jd_title" value="{{ jd.title or '' }}" required
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Job ID -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">Job ID</label>
          <input name="jd_code" value="{{ jd.jd_id or jd.code or '' }}" required
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Department / Team -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">Department / Team</label>
          <input name="jd_department" value="{{ jd.department or '' }}"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Location (required) -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">
            Location <span class="text-red-500">*</span>
          </label>
          <input name="jd_location" value="{{ jd.location or '' }}" required
                 placeholder="e.g., San Francisco, CA (Remote)"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Start date/time (required date) -->
        <div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-gray-700 mb-1">
                Start Date <span class="text-red-500">*</span>
              </label>
              <input type="date" name="jd_start" value="{{ jd.start_date.strftime('%Y-%m-%d') if jd.start_date else '' }}" required # 2025-10-01(Jen): Fix date format for HTML date input - convert DateTime to YYYY-MM-DD format
                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">Start Time</label>
              <input type="time" name="start_time" value="{{ jd.start_time or '' }}"
                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
            </div>
          </div>
        </div>

        <!-- End date/time (required date) -->
        <div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-gray-700 mb-1">
                End Date <span class="text-red-500">*</span>
              </label>
              <input type="date" name="jd_end" value="{{ jd.end_date.strftime('%Y-%m-%d') if jd.end_date else '' }}" required # 2025-10-01(Jen): Fix date format for HTML date input - convert DateTime to YYYY-MM-DD format
                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1">End Time</label>
              <input type="time" name="end_time" value="{{ jd.end_time or '' }}"
                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
            </div>
          </div>
        </div>

        <!-- Employment Type (required) -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">
            Employment Type <span class="text-red-500">*</span>
          </label>
          <input name="jd_employment_type" value="{{ jd.employment_type or '' }}" required
                 placeholder="e.g., Full-time"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Work Arrangement -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">Work Arrangement</label>
          <input name="work_arrangement" value="{{ jd.work_arrangement or '' }}"
                 placeholder="Onsite / Hybrid / Remote"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <!-- Salary Range -->
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">Salary Range</label>
          <input name="jd_salary_range" value="{{ jd.salary_range or '' }}" placeholder="e.g., $90,000 â€“ $120,000 annually"
                 class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>
      </div>

      <!-- Role description -->
      <div class="mt-4 space-y-2">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold text-title" style="font-family: 'Poppins', sans-serif;">Role Description</h3>
          <span class="text-xs text-gray-500 flex items-center gap-1">
            <svg class="w-3 h-3 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Example: **bold**, - list item, [link](https://example.com)">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Markdown format supported
          </span>
        </div>
        <textarea id="jd_markdown" name="jd_text" rows="10"
                  class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">{{ prefill_markdown|e }}</textarea>
      </div>
    </div>

    <!-- Self-identification survey -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <h2 class="text-xl font-semibold text-title mb-3" style="font-family: 'Poppins', sans-serif;">Self-Identification Survey</h2>

      <!-- tiny fallback so the knob slides even if Tailwind misses peer-checked -->
      <style>
        input.peer:checked + span > span { transform: translateX(1rem); }
        input.peer:checked + span { background: rgb(59 130 246); }
      </style>

      <label class="inline-flex items-center gap-2 cursor-pointer">
        <input type="checkbox" name="id_surveys_enabled" value="1"
               class="sr-only peer"
               {% if jd and jd.id_surveys_enabled %}checked{% endif %}>

        <span class="relative inline-block w-9 h-5 bg-gray-200 rounded-full transition
                     peer-checked:bg-blue-500">
          <span class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow transform transition
                       peer-checked:translate-x-4"></span>
        </span>

        <span class="text-sm text-gray-700">Enable self-identification survey</span>
      </label>
    </div>

    <!-- Question Settings (own card) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-xl font-semibold text-title" style="font-family: 'Poppins', sans-serif;">Question Settings</h2>
          <p class="text-sm text-gray-500 mt-1">
            Customize how many screening questions will be asked for this role.
          </p>
        </div>
      </div>

      <div class="mt-4 max-w-xs">
        <label class="block text-sm text-gray-700 mb-1">Number of Questions</label>
        <select name="question_count"
                class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
          {% set qc = (jd.question_count if jd and jd.question_count is not none else 3) %}
          {% for n in [1,2,3,4,5] %}
          <option value="{{ n }}" {% if qc==n %}selected{% endif %}>{{ n }} question{{ '' if n==1 else 's' }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Application Link (Figma-style) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <h2 class="text-xl font-semibold text-title" style="font-family: 'Poppins', sans-serif;">Application Link</h2>
      <p class="text-sm text-gray-500 mt-1">
        Once you publish this job posting, candidates will be able to apply using the link below.
        Share this link on your website, social media, or job boards.
      </p>

      <div class="mt-3 flex items-center gap-2 max-w-2xl">
        <input id="applyLink" readonly
               value="{{ apply_url or '' }}"
               class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm bg-gray-50 select-all" />
        <button type="button" id="copyBtn"
                class="inline-flex items-center rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">
          Copy
        </button>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-end gap-2">
      {# Delete: server enforces "no delete if applicants exist" #}
      <a href="{{ url_for('delete_jd', tenant=tenant_slug, code=jd.code) }}"
         class="rounded-lg border px-3 py-2 text-sm
                {{ '' if not has_candidates else 'pointer-events-none opacity-50' }}"
         onclick="return confirm('Delete this job?');">
        Delete
      </a>
      {% if has_candidates %}
        <span class="ml-2 text-xs text-gray-500 align-middle">Disabled: job has applicants</span>
      {% endif %}

      {# Close = simple link back (no post) #}
      <a href="{{ url_for('recruiter', tenant=tenant_slug) }}"
         data-noload
         class="rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">Close</a>

      {# Save as Draft (sets status) #}
      <button type="submit"
              onclick="document.getElementById('jd_status').value='draft'"
              class="rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">
        Save as Draft
      </button>

      {# Publish (sets status to open) #}
      <button type="submit"
              onclick="document.getElementById('jd_status').value='open'"
              class="rounded-lg bg-blue-600 text-white px-3 py-2 text-sm hover:bg-blue-700">
        Publish Job
      </button>
    </div>

  </form>
</div>

<script>
// Copy application link
const copyBtn = document.getElementById('copyBtn');
if (copyBtn) {
  copyBtn.addEventListener('click', async () => {
    const el = document.getElementById('applyLink');
    try { await navigator.clipboard.writeText(el.value || ''); copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent='Copy', 1400); }
    catch { el.select(); document.execCommand('copy'); copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent='Copy', 1400); }
  });
}
</script>
{% endblock %}

{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const textarea = document.getElementById('jd_markdown');
    if (!textarea) return;

    new EasyMDE({
      element: textarea,
      spellChecker: false,
      status: false,
      autofocus: false,
      forceSync: true,
      renderingConfig: { singleLineBreaks: false },
      toolbar: [
        'bold', 'italic', 'heading', '|',
        'unordered-list', 'ordered-list', 'quote', '|',
        'link', 'preview', 'guide'
      ]
    });
  });
</script>
{% endblock %}
