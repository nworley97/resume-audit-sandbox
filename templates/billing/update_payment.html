{% extends "base_app.html" %}
{% block title %}Update Payment Method - ALTERA{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto">
  <a href="{{ url_for('billing.account') }}" class="text-slate-500 hover:text-slate-700 text-sm mb-4 inline-flex items-center gap-1">
    <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
    </svg>
    Back to Billing
  </a>
  
  <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
    <h1 class="text-xl font-semibold text-title mb-2">Update Payment Method</h1>
    <p class="text-slate-500 text-sm mb-6">
      Enter your new card details below.
    </p>
    
    
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-6">
      {% for category, message in messages %}
      <div class="p-4 rounded-lg {% if category == 'error' %}bg-red-50 text-red-700{% else %}bg-green-50 text-green-700{% endif %}">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    
    <!-- Current Card -->
    {% if subscription and subscription.payment_method_last4 %}
    <div class="bg-slate-50 rounded-lg p-4 mb-6">
      <div class="text-sm text-slate-500 mb-1">Current Card</div>
      <div class="flex items-center gap-2">
        <span class="font-medium text-title">
          {{ subscription.payment_method_brand | capitalize }} •••• {{ subscription.payment_method_last4 }}
        </span>
        <span class="text-sm text-slate-400">
          Expires {{ "%02d"|format(subscription.payment_method_exp_month) }}/{{ subscription.payment_method_exp_year }}
        </span>
      </div>
    </div>
    {% endif %}
    
    <form method="POST" action="{{ url_for('billing.update_payment') }}">
      <div class="space-y-4">
        <div>
          <label for="card_number" class="block text-sm font-medium text-slate-700 mb-1">
            Card Number
          </label>
          <input type="text" id="card_number" name="card_number" required 
                 placeholder="1234 5678 9012 3456"
                 pattern="[\d\s]{13,19}"
                 maxlength="19"
                 autocomplete="cc-number"
                 class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
        </div>
        
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label for="exp_month" class="block text-sm font-medium text-slate-700 mb-1">
              Month
            </label>
            <select id="exp_month" name="exp_month" required 
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
              <option value="">MM</option>
              {% for m in range(1, 13) %}
              <option value="{{ m }}">{{ "%02d"|format(m) }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="exp_year" class="block text-sm font-medium text-slate-700 mb-1">
              Year
            </label>
            <select id="exp_year" name="exp_year" required
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
              <option value="">YYYY</option>
              {% for y in range(2025, 2037) %}
              <option value="{{ y }}">{{ y }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="cvc" class="block text-sm font-medium text-slate-700 mb-1">
              CVC
            </label>
            <input type="text" id="cvc" name="cvc" required 
                   placeholder="123"
                   pattern="\d{3,4}"
                   maxlength="4"
                   autocomplete="cc-csc"
                   class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
          </div>
        </div>
      </div>
      
      <button type="submit" class="w-full mt-6 bg-primary text-white py-3 rounded-lg font-medium hover:bg-primary/90 transition-colors">
        Update Payment Method
      </button>
    </form>
    
    <div class="mt-4 flex items-center justify-center gap-2 text-xs text-slate-400">
      <svg class="w-4 h-4 text-green-500" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
      </svg>
      <span>Secure payment powered by Stripe</span>
    </div>
  </div>
</div>

<script>
(function() {
  // Format card number with spaces
  const cardInput = document.getElementById('card_number');
  cardInput.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
    let formatted = '';
    for (let i = 0; i < value.length; i++) {
      if (i > 0 && i % 4 === 0) {
        formatted += ' ';
      }
      formatted += value[i];
    }
    e.target.value = formatted;
  });
  
  // CVC input - numbers only
  const cvcInput = document.getElementById('cvc');
  cvcInput.addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
  });
})();
</script>
{% endblock %}

