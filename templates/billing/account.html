{% extends "base_app.html" %}
{% block title %}Billing & Subscription - ALTERA{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <h1 class="text-2xl font-semibold text-title mb-6">Billing & Subscription</h1>
  
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div class="mb-6">
    {% for category, message in messages %}
    <div class="p-4 rounded-lg {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}
  
  <!-- Current Plan Card -->
  <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
    <div class="flex items-start justify-between">
      <div>
        <h2 class="text-lg font-semibold text-title mb-1">Current Plan</h2>
        <p class="text-slate-500 text-sm">{{ summary.plan_display }} Plan 
          {% if summary.is_grandfathered %}
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 ml-2">
            Grandfathered
          </span>
          {% endif %}
        </p>
      </div>
      {% if not summary.is_grandfathered %}
      <a href="{{ url_for('billing.change_plan') }}" class="text-primary hover:text-primary/80 text-sm font-medium">
        Change Plan →
      </a>
      {% endif %}
    </div>
    
    {% if not summary.is_grandfathered %}
    <div class="mt-4 grid grid-cols-3 gap-4">
      <!-- Jobs Usage -->
      <div class="bg-slate-50 rounded-lg p-4">
        <div class="text-sm text-slate-500 mb-1">Active Jobs</div>
        <div class="text-2xl font-semibold text-title">
          {{ summary.jobs_used }} / {{ summary.jobs_limit }}
        </div>
        <div class="mt-2 h-2 bg-slate-200 rounded-full overflow-hidden">
          <div class="h-full bg-primary rounded-full transition-all duration-300" 
               style="width: {{ (summary.jobs_used / summary.jobs_limit * 100) | min(100) }}%"></div>
        </div>
      </div>
      
      <!-- Resumes Usage -->
      <div class="bg-slate-50 rounded-lg p-4">
        <div class="text-sm text-slate-500 mb-1">Resumes This Period</div>
        <div class="text-2xl font-semibold text-title">
          {{ summary.resumes_used }} / {{ summary.resumes_limit }}
        </div>
        <div class="mt-2 h-2 bg-slate-200 rounded-full overflow-hidden">
          <div class="h-full bg-primary rounded-full transition-all duration-300" 
               style="width: {{ (summary.resumes_used / summary.resumes_limit * 100) | min(100) }}%"></div>
        </div>
      </div>
      
      <!-- Seats Usage -->
      <div class="bg-slate-50 rounded-lg p-4">
        <div class="text-sm text-slate-500 mb-1">Team Seats</div>
        <div class="text-2xl font-semibold text-title">
          {{ summary.seats_used }} / {{ summary.seats_limit }}
        </div>
        <div class="mt-2 h-2 bg-slate-200 rounded-full overflow-hidden">
          <div class="h-full bg-primary rounded-full transition-all duration-300" 
               style="width: {{ (summary.seats_used / summary.seats_limit * 100) | min(100) }}%"></div>
        </div>
        {% if summary.extra_seats > 0 %}
        <div class="text-xs text-slate-400 mt-1">
          +{{ summary.extra_seats }} extra seat(s)
        </div>
        {% endif %}
      </div>
    </div>
    
    {% if summary.period_end %}
    <div class="mt-4 text-sm text-slate-500">
      Current billing period ends: <strong>{{ summary.period_end.strftime('%B %d, %Y') }}</strong>
    </div>
    {% endif %}
    {% else %}
    <div class="mt-4 p-4 bg-purple-50 rounded-lg">
      <p class="text-purple-800 text-sm">
        Your account has been grandfathered with full access to all features. Thank you for being an early adopter!
      </p>
    </div>
    {% endif %}
  </div>
  
  <!-- Quick Actions -->
  {% if not summary.is_grandfathered %}
  <div class="grid grid-cols-2 gap-4 mb-6">
    <a href="{{ url_for('billing.add_seats') }}" 
       class="bg-white rounded-lg shadow-sm border border-slate-200 p-4 hover:border-primary transition-colors">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-primary" viewBox="0 0 20 20" fill="currentColor">
            <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
          </svg>
        </div>
        <div>
          <div class="font-medium text-title">Add Seats</div>
          <div class="text-sm text-slate-500">${{ extra_seat_price }}/mo per seat</div>
        </div>
      </div>
    </a>
    
    <a href="{{ url_for('billing.update_payment') }}" 
       class="bg-white rounded-lg shadow-sm border border-slate-200 p-4 hover:border-primary transition-colors">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-primary" viewBox="0 0 20 20" fill="currentColor">
            <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
            <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div>
          <div class="font-medium text-title">Update Payment</div>
          {% if subscription and subscription.payment_method_last4 %}
          <div class="text-sm text-slate-500">
            {{ subscription.payment_method_brand | capitalize }} •••• {{ subscription.payment_method_last4 }}
          </div>
          {% else %}
          <div class="text-sm text-slate-500">Update card on file</div>
          {% endif %}
        </div>
      </div>
    </a>
  </div>
  
  <!-- Cancel Subscription -->
  {% if subscription and subscription.status == 'active' %}
  <div class="mb-6">
    <a href="{{ url_for('billing.cancel_subscription') }}" 
       class="text-sm text-slate-500 hover:text-red-600 transition-colors">
      Cancel subscription
    </a>
  </div>
  {% elif subscription and subscription.status == 'canceled' %}
  <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
    <p class="text-sm text-amber-800">
      <strong>Subscription canceled.</strong> You have access until {{ subscription.get_period_end_date().strftime('%B %d, %Y') }}.
      <a href="{{ url_for('billing.change_plan') }}" class="underline hover:no-underline">Reactivate</a>
    </p>
  </div>
  {% endif %}
  {% endif %}
  
  <!-- Payment History -->
  <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-200">
      <h2 class="text-lg font-semibold text-title">Payment History</h2>
    </div>
    
    {% if payments %}
    <table class="w-full">
      <thead class="bg-slate-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Description</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Amount</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200">
        {% for payment in payments %}
        <tr>
          <td class="px-6 py-4 text-sm text-slate-900">
            {{ payment.created_at.strftime('%b %d, %Y') }}
          </td>
          <td class="px-6 py-4 text-sm text-slate-600">
            {{ payment.description }}
          </td>
          <td class="px-6 py-4 text-sm text-slate-900">
            ${{ "%.2f"|format(payment.amount) }} {{ payment.currency }}
          </td>
          <td class="px-6 py-4">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                         {% if payment.status == 'succeeded' %}bg-green-100 text-green-800
                         {% elif payment.status == 'failed' %}bg-red-100 text-red-800
                         {% else %}bg-yellow-100 text-yellow-800{% endif %}">
              {{ payment.status | capitalize }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="px-6 py-8 text-center text-slate-500">
      <p>No payment history yet.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

