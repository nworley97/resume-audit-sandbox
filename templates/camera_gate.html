{% extends "base.html" %}
{% block content %}

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">

          <h2 class="h4 mb-3">Camera Check</h2>
          <p class="text-muted mb-4">
            Hi {{ c.name }} — before we begin your questions, we request temporary access to your camera to verify identity.
          </p>

          <!-- Warning that does not block progress -->
          <div class="alert alert-danger d-flex align-items-start gap-2" role="alert">
            <div class="mt-1">⚠️</div>
            <div>
              <strong>Important:</strong> If you do <em>not</em> allow camera access,
              your application may be considered <strong>void</strong>.
              You can still continue now, but we may not review your submission.
            </div>
          </div>

          <!-- Camera preview / status -->
          <div class="row g-3 align-items-center mb-3">
            <div class="col-md-7">
              <div class="ratio ratio-4x3 bg-light rounded-3 overflow-hidden border">
                <video id="camPreview" autoplay playsinline muted></video>
              </div>
            </div>
            <div class="col-md-5">
              <div id="camStatus" class="small text-muted">
                Requesting camera permission…
              </div>
              <ul class="small text-muted mt-2 mb-0">
                <li>Your video is not stored.</li>
                <li>You can disable camera after this step.</li>
              </ul>
            </div>
          </div>

          <form method="post" class="needs-validation" novalidate>
            <!-- REQUIRED acknowledgement (must be checked to submit) -->
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" value="1" id="ackBox" name="ack" required>
              <label class="form-check-label" for="ackBox">
                I understand that blocking camera access may void my application.
              </label>
              <div class="invalid-feedback">Please acknowledge to continue.</div>
            </div>

            <!-- We record camera outcome for reference; backend can ignore -->
            <input type="hidden" name="cam" id="camField" value="pending">

            <div class="d-flex justify-content-between">
              <a class="btn btn-outline-secondary" href="{{ url_for('apply', code=c.jd_code) }}">Back</a>
              <button type="submit" class="btn btn-primary">
                Continue
              </button>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>

<style>
  #camPreview { width: 100%; height: 100%; object-fit: cover; background: #000; }
</style>

<script>
(function () {
  const statusEl = document.getElementById('camStatus');
  const videoEl  = document.getElementById('camPreview');
  const camField = document.getElementById('camField');

  // Bootstrap-style client-side validation for the required checkbox
  document.querySelectorAll('.needs-validation').forEach((form) => {
    form.addEventListener('submit', (e) => {
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });

  // Try to get camera; continue is allowed regardless of result
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true })
      .then((stream) => {
        try { videoEl.srcObject = stream; }
        catch { videoEl.src = window.URL.createObjectURL(stream); }
        camField.value = 'granted';
        statusEl.innerHTML = '<span class="text-success">Camera access granted.</span>';
      })
      .catch((err) => {
        camField.value = 'denied';
        statusEl.innerHTML =
          '<span class="text-danger">Camera access blocked or unavailable.</span> ' +
          '<span class="text-muted">You can still continue, but your application may be void.</span>';
        console.warn('getUserMedia error:', err);
      });
  } else {
    camField.value = 'unsupported';
    statusEl.innerHTML =
      '<span class="text-warning">Camera not supported on this device/browser.</span> ' +
      '<span class="text-muted">You can still continue.</span>';
  }
})();
</script>

{% endblock %}
