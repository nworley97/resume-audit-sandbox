{% extends "base_public.html" %}
{% block title %}Interview Setup{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <!-- Heading -->
  <div class="text-center mb-8">
    <h1 class="text-2xl md:text-3xl font-semibold text-gray-900">Hi {{ first_name }}!</h1>
    <p class="mt-2 text-lg md:text-xl text-gray-900">
      To help us get to know you better, <br class="hidden md:block"/>
      please answer a few short questions.
    </p>
  </div>

  <!-- Preparation Tips -->
  <div class="bg-white rounded-xl ring-1 ring-gray-200 p-4 md:p-5 mb-4">
    <div class="font-semibold text-gray-900 mb-3">Preparation Tips</div>

    <div class="divide-y divide-gray-200">
      <div class="py-3 flex items-start gap-3">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-[#ecfdf5] ring-1 ring-[#99f6e4]">
          <svg class="h-3.5 w-3.5 text-primary" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M16.704 5.29a1 1 0 00-1.408-1.418L8.5 10.67 5.7 7.87a1 1 0 10-1.4 1.43l3.5 3.5a1 1 0 001.42 0l7.484-7.51z" clip-rule="evenodd"/>
          </svg>
        </span>
        <div>
          <div class="text-primary text-sm font-medium">Stable Internet Connection</div>
          <div class="text-xs text-gray-500">Ensure you have a reliable internet connection to avoid interruptions during the interview.</div>
        </div>
      </div>

      <div class="py-3 flex items-start gap-3">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-[#ecfdf5] ring-1 ring-[#99f6e4]">
          <svg class="h-3.5 w-3.5 text-primary" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M16.704 5.29a1 1 0 00-1.408-1.418L8.5 10.67 5.7 7.87a1 1 0 10-1.4 1.43l3.5 3.5a1 1 0 001.42 0l7.484-7.51z" clip-rule="evenodd"/>
          </svg>
        </span>
        <div>
          <div class="text-primary text-sm font-medium">Quiet Environment</div>
          <div class="text-xs text-gray-500">Choose a quiet place to minimize background noise and distractions.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Camera Access -->
  <div class="bg-white rounded-xl ring-1 ring-gray-200 p-4 md:p-5 mb-4">
    <div class="font-semibold text-gray-900">Allow Camera Access</div>
    <p class="mt-1 text-xs text-gray-500">
      To ensure fairness and authenticity for all candidates, please allow access to your camera before starting.
      Your video and activity data will only be used for identity verification and evaluation integrity purposes
      and will not be shared externally.
    </p>

    <!-- Permission prompt image (make sure file is named exactly static/img/camera-allow.png) -->
    <div class="mt-4 flex justify-center">
      <img
        src="{{ url_for('static', filename='img/camera-allow.jpg') }}"
        alt="Browser camera permission prompt"
        class="max-w-xs w-full rounded-lg ring-1 ring-gray-200"
      >
    </div>

    <div class="mt-4 flex justify-center">
      <div id="camStatus" class="inline-flex items-center gap-2 rounded-lg border border-primary/40 bg-[#ecfdf5] px-3 py-2 text-xs text-primary font-medium">
        <span class="inline-flex h-2.5 w-2.5 items-center justify-center">
          <span class="block h-2 w-2 rounded-full bg-primary animate-pulse"></span>
        </span>
        <span class="tracking-wide">Camera permission: <span data-status>Pending</span></span>
      </div>
    </div>

    <!-- Actions -->
    <div class="mt-4 flex flex-col items-center gap-3">
      <button id="btnAllow" type="button"
              class="inline-flex items-center rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-[#0b7c70]">
        Allow camera access
      </button>
      <a id="btnRetry" href="#" class="hidden text-xs text-primary hover:text-[#0b7c70] underline">Try again</a>
    </div>
  </div>

  <!-- Agreement -->
  <div class="bg-white rounded-xl ring-1 ring-gray-200 p-4 md:p-5 mb-6">
    <div class="text-xs text-gray-700 font-medium mb-2">
      Failure to answer questions may result in removal from consideration for this role.
    </div>
    <label class="flex items-start gap-2 text-xs text-gray-700">
      <input id="agree" type="checkbox" class="mt-0.5 rounded border-gray-300">
      <span>I understand that not responding to questions may forfeit my opportunity</span>
    </label>
  </div>

  <!-- Start -->
  <form method="get" action="{{ next_url }}">
    <div class="text-center">
      <button id="btnStart" type="submit"
              class="inline-flex items-center justify-center rounded-lg bg-gray-300 px-4 py-2 text-sm font-semibold text-white cursor-not-allowed"
              disabled>
        Start
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block body_extra %}
<script>
  const btnAllow   = document.getElementById('btnAllow');
  const btnRetry   = document.getElementById('btnRetry');
  const camStatus  = document.getElementById('camStatus');
  const statusText = camStatus?.querySelector('[data-status]');
  const agree      = document.getElementById('agree');
  const btnStart   = document.getElementById('btnStart');

  let camAllowed = false;

  function updateStartState() {
    const ok = camAllowed && !!agree.checked;
    btnStart.disabled = !ok;
    btnStart.className =
      'inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-semibold ' +
      (ok ? 'bg-primary text-white hover:bg-[#0b7c70] cursor-pointer'
          : 'bg-gray-300 text-white cursor-not-allowed');
  }

  async function requestCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      if (statusText) statusText.textContent = 'Not supported';
      return;
    }
    try {
      if (statusText) statusText.textContent = 'Requestingâ€¦';
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      stream.getTracks().forEach(t => t.stop());
      camAllowed = true;
      if (statusText) statusText.textContent = 'Allowed';
      camStatus?.classList.remove('border-primary/40', 'border-rose-300');
      camStatus?.classList.add('border-primary');
      btnRetry.classList.add('hidden');
      if (window.showToast) {
        window.showToast('Camera access granted.');
      }
      updateStartState();
    } catch (e) {
      camAllowed = false;
      if (statusText) statusText.textContent = 'Blocked';
      camStatus?.classList.remove('border-primary', 'border-primary/40');
      camStatus?.classList.add('border-rose-300');
      if (window.showToast) {
        window.showToast('Camera access was blocked. Please allow access to continue.', 'error', { duration: 3200 });
      }
      btnRetry.classList.remove('hidden');
      updateStartState();
    }
  }

  btnAllow?.addEventListener('click', requestCamera);
  btnRetry?.addEventListener('click', (e) => { e.preventDefault(); requestCamera(); });
  agree?.addEventListener('change', updateStartState);

  updateStartState();
</script>
<script>
(function () {
  const flagUrl = "{{ url_for('flag_tab_switch', tenant=tenant_slug, code=code, cid=cid) }}";
  function sendFlag() {
    try { navigator.sendBeacon(flagUrl); }
    catch { fetch(flagUrl, { method: 'POST', keepalive: true }); }
  }
  document.addEventListener('visibilitychange', () => { if (document.hidden) sendFlag(); });
  window.addEventListener('pagehide', sendFlag);
})();
</script>

{% endblock %}
