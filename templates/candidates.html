{% extends "base_app.html" %}
{% block title %}Candidates Overview - ALTERA{% endblock %}

{% block content %}

{# ---------- PAGE HEADER (Rate/Export outside the card in Figma) ---------- #}
<div class="flex items-start justify-between mb-4">
  <div>
    <div class="flex items-center gap-2 text-slate text-sm mb-2">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
        <rect x="3"  y="3"  width="7" height="7" rx="1.5"></rect>
        <rect x="14" y="3"  width="7" height="7" rx="1.5"></rect>
        <rect x="3"  y="14" width="7" height="7" rx="1.5"></rect>
        <rect x="14" y="14" width="7" height="7" rx="1.5"></rect>
      </svg>
      <span>Candidates</span>
    </div>
    <h1 class="text-2xl font-semibold text-title">Candidates Overview</h1>
    <p class="text-slate mt-1">Manage and review candidate applications with intelligent insights</p>
  </div>

  <div class="flex items-center gap-2">
    <button type="button"
            class="inline-flex items-center gap-2 rounded-lg border border-gray-300 text-sm px-3 py-2 hover:bg-gray-50">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
        <path d="M12 6l3 6h-6l3-6Z"></path><path d="M6 18h12"></path>
      </svg>
      Rate
    </button>

    <a href="{{ url_for('export_candidates_csv', tenant=tenant.slug if tenant else None, q=q) }}"
       class="inline-flex items-center gap-2 rounded-lg border border-gray-300 text-sm px-3 py-2 hover:bg-gray-50">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
        <path d="M12 3v12M7 10l5 5 5-5" stroke-linecap="round" stroke-linejoin="round"/>
        <rect x="4" y="17" width="16" height="4" rx="1.5"></rect>
      </svg>
      Export
    </a>
  </div>
</div>

{# ---------- EMPTY STATE ---------- #}
{% if total == 0 %}
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-16 text-center">
    <p class="text-title font-medium">No applicants yet</p>
    <p class="text-slate mt-2">Once candidates apply, theyâ€™ll appear here for review and scoring.</p>
    <a href="{{ url_for('recruiter', tenant=tenant.slug if tenant else None) }}"
       class="mt-6 inline-flex items-center rounded-lg bg-primary text-white text-sm font-medium px-3 py-2 hover:opacity-95">
      View Job Description
    </a>
  </div>
  {% endblock %}
  {% return %}
{% endif %}

{# ---------- CARD ---------- #}
<div class="bg-white rounded-xl shadow-sm border border-gray-200">

  {# --- Header: search + total count --- #}
  <div class="flex items-center justify-between gap-3 p-4 border-b border-gray-200">
    <form action="{{ url_for('global_candidates', tenant=tenant.slug if tenant else None) }}" method="get" class="w-full max-w-md">
      <input type="hidden" name="sort" value="{{ sort or '' }}">
      <input type="hidden" name="dir"  value="{{ dir or ''  }}">
      <div class="relative">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate/70">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <circle cx="11" cy="11" r="7"></circle><path d="M20 20L17 17"></path>
          </svg>
        </span>
        <input class="w-full rounded-lg border border-gray-300 pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
               type="text" name="q" value="{{ q or '' }}" placeholder="Search by name, job, or department"/>
      </div>
    </form>

    <div class="text-sm text-title/80">
      {{ "{:,}".format(total) }} Candidates
    </div>
  </div>

  {# --- Sort helpers --- #}
  {% macro sort_link(label, key) -%}
    {% set active = (sort==key) %}
    {% set asc = (active and dir=='asc') %}
    {% set desc = (active and dir=='desc') %}
    <div class="inline-flex items-center gap-1">
      <span>{{ label }}</span>
      <span class="flex flex-col leading-none">
        <a class="h-2 {{ 'text-title' if asc else 'text-slate/40' }}"
           href="{{ url_for('global_candidates', tenant=tenant.slug if tenant else None, q=q, page=1, per_page=per_page, sort=key, dir='asc') }}">
          <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M6 14l6-6 6 6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
        <a class="h-2 {{ 'text-title' if desc else 'text-slate/40' }}"
           href="{{ url_for('global_candidates', tenant=tenant.slug if tenant else None, q=q, page=1, per_page=per_page, sort=key, dir='desc') }}">
          <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M6 10l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </span>
    </div>
  {%- endmacro %}

  {# --- Chip helpers --- #}
  {% macro score_chip(val) -%}
    {% if val is not none %}
      {% set cls = 'bg-red-100 text-red-700' %}
      {% if val >= SCORE_GREEN %}{% set cls = 'bg-green-100 text-green-700' %}
      {% elif val >= SCORE_YELLOW %}{% set cls = 'bg-yellow-100 text-yellow-700' %}{% endif %}
      <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium {{ cls }}">{{ '%.2f'|format(val) }}</span>
    {% endif %}
  {%- endmacro %}

  {% macro rel_chip(val) -%}
    {% if val is not none %}
      {% set cls = 'bg-red-100 text-red-700' %}
      {% if val >= REL_GREEN %}{% set cls = 'bg-green-100 text-green-700' %}
      {% elif val >= REL_YELLOW %}{% set cls = 'bg-yellow-100 text-yellow-700' %}{% endif %}
      <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium {{ cls }}">{{ val }}%</span>
    {% endif %}
  {%- endmacro %}

  {# --- Table --- #}
  <div class="px-2 pb-2">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-slate border-y border-gray-200">
            <th class="text-left font-medium py-3 pl-4 w-10">
              <input type="checkbox" class="rounded border-gray-300">
            </th>
            <th class="text-left font-medium py-3 w-64">{{ sort_link('Name', 'name') }}</th>
            <th class="text-left font-medium py-3 w-56">{{ sort_link('Job Title', 'job') }}</th>
            <th class="text-left font-medium py-3 w-40">{{ sort_link('Department', 'dept') }}</th>
            <th class="text-left font-medium py-3 w-40">{{ sort_link('Claim Validity', 'score') }}</th>
            <th class="text-left font-medium py-3 w-32">{{ sort_link('Relevancy', 'relevancy') }}</th>
            <th class="text-left font-medium py-3 w-40">{{ sort_link('Date of Application', 'applied') }}</th>
          </tr>
        </thead>

        <tbody>
          {% for c in items %}
          <tr class="border-t border-gray-200 hover:bg-gray-50/60">
            <td class="py-3 pl-4"><input type="checkbox" class="rounded border-gray-300"></td>
            <td class="py-3 text-title">{{ c.name }}</td>
            <td class="py-3">{{ c.job_title }}</td>
            <td class="py-3">{{ c.department }}</td>
            <td class="py-3">{{ score_chip(c.score) }}</td>
            <td class="py-3">{{ rel_chip(c.relevancy) }}</td>
            <td class="py-3">
              {% set dt = c.applied_at %}
              {{ dt.strftime('%b %d, %Y') if dt else '' }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# --- Pagination (arrows tight next to numbers, like we fixed on recruiter) --- #}
    <div class="flex items-center justify-center gap-1 px-2 py-4">
      {% if page > 1 %}
        <a class="inline-flex items-center gap-1 rounded-md px-2 py-1 text-sm hover:bg-gray-100"
           href="{{ url_for('global_candidates', tenant=tenant.slug if tenant else None, q=q, sort=sort, dir=dir, page=page-1, per_page=per_page) }}">
          <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M10 19l-7-7 7-7M3 12h18" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      {% endif %}

      {% for p in range(1, pages + 1) %}
        <a href="{{ url_for('global_candidates', tenant=tenant.slug if tenant else None, q=q, sort=sort, dir=dir, page=p, per_page=per_page) }}"
           class="min-w-[2rem] text-center rounded-md px-2 py-1 text-sm {{ 'bg-gray-900 text-white' if p==page else 'hover:bg-gray-100 text-title' }}">
          {{ p }}
        </a>
      {% endfor %}

      {% if page < pages %}
        <a class="inline-flex items-center gap-1 rounded-md px-2 py-1 text-sm hover:bg-gray-100"
           href="{{ url_for('global_candidates', tenant=tenant.slug if tenant else None, q=q, sort=sort, dir=dir, page=page+1, per_page=per_page) }}">
          <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M14 5l7 7-7 7M3 12h18" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
