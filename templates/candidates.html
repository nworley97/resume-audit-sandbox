{% extends "base_app.html" %}
{% block title %}{% if jd %}Candidates – {{ jd.title }}{% else %}Candidates Overview - ALTERA{% endif %}{% endblock %}
{% block content %}
<div class="space-y-4">

  <!-- Header -->
  <div class="flex items-start justify-between mb-4">
    <div>
      <div class="flex items-center gap-2 text-slate text-sm mb-2">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
          <path d="M16 11c1.657 0 3-1.79 3-4s-1.343-4-3-4-3 1.79-3 4 1.343 4 3 4Z"></path>
          <path d="M8 12c1.657 0 3-1.79 3-4S9.657 4 8 4 5 5.79 5 8s1.343 4 3 4Z"></path>
          <path d="M2 20c0-2.761 2.91-5 6.5-5S15 17.239 15 20"></path>
          <path d="M15 15.5c3.59 0 6.5 2.239 6.5 5"></path>
        </svg>
        <span>Candidates</span>
      </div>
      <h1 class="text-2xl font-semibold text-title">
        {% if jd %}Candidates for {{ jd.title }}{% else %}Candidates Overview{% endif %}
      </h1>
      <p class="text-slate mt-1">
        {% if jd %}Manage and review candidate applications for this job
        {% else %}Manage and review candidate applications with intelligent insights{% endif %}
      </p>
    </div>
  </div>

  {% if (total or 0) == 0 %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
      <div class="p-12 text-center text-slate">
        <div class="text-title text-lg mb-2">No applicants yet</div>
        <div class="text-sm mb-6">Once candidates apply, they’ll appear here for review and scoring.</div>
        <a href="{{ url_for('recruiter', tenant=tenant.slug if tenant else None) }}"
           class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">
          View Job Postings
        </a>
      </div>
    </div>
  {% else %}

  <div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="flex items-center justify-between gap-3 p-4 border-b border-gray-200">
      <form action="{% if jd %}{{ url_for('view_candidates', tenant=tenant.slug if tenant else None, code=jd.code) }}{% else %}{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None) }}{% endif %}"
            method="get" class="w-full max-w-md">
        <input type="hidden" name="sort" value="{{ sort or '' }}">
        <input type="hidden" name="dir"  value="{{ dir  or '' }}">
        <input type="hidden" name="page" value="1">
        <div class="relative">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate/70">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <circle cx="11" cy="11" r="7"></circle><path d="M20 20L17 17"></path>
            </svg>
          </span>
          <input class="w-full rounded-lg border border-gray-300 pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                 type="text" name="q" value="{{ q or '' }}" placeholder="Name, Job Title, JD Code, Department"/>
        </div>
      </form>
    </div>

    {% macro sort_link(label, key) -%}
      {% set base = 'view_candidates' if jd else 'candidates_overview' %}
      {% set active = (sort==key) %}
      {% set asc = (active and dir=='asc') %}
      {% set desc = (active and dir=='desc') %}
      <div class="inline-flex items-center gap-1">
        <span>{{ label }}</span>
        <span class="flex flex-col leading-none">
          <a class="h-2 {{ 'text-title' if asc else 'text-slate/40' }}"
             href="{% if jd %}{{ url_for(base, tenant=tenant.slug if tenant else None, code=jd.code, q=q, page=1, sort=key, dir='asc') }}{% else %}{{ url_for(base, tenant=tenant.slug if tenant else None, q=q, page=1, sort=key, dir='asc') }}{% endif %}">
            ▲
          </a>
          <a class="h-2 {{ 'text-title' if desc else 'text-slate/40' }}"
             href="{% if jd %}{{ url_for(base, tenant=tenant.slug if tenant else None, code=jd.code, q=q, page=1, sort=key, dir='desc') }}{% else %}{{ url_for(base, tenant=tenant.slug if tenant else None, q=q, page=1, sort=key, dir='desc') }}{% endif %}">
            ▼
          </a>
        </span>
      </div>
    {%- endmacro %}

    <div class="px-2 pb-2">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-slate border-y border-gray-200">
              <th class="text-left font-medium py-3 pl-4 w-10"></th>
              <th class="text-left font-medium py-3 w-56">{{ sort_link('Name', 'name') }}</th>
              <th class="text-left font-medium py-3 w-40">{{ sort_link('Job Title', 'job') }}</th>
              <th class="text-left font-medium py-3 w-44">{{ sort_link('Department', 'dept') }}</th>
              <th class="text-left font-medium py-3 w-28">{{ sort_link('Claim Validity', 'score') }}</th>
              <th class="text-left font-medium py-3 w-28">{{ sort_link('Relevancy Score', 'relevancy') }}</th>
              <th class="text-left font-medium py-3 w-40">{{ sort_link('Date of Application', 'applied') }}</th>
              <th class="py-3 w-16"></th>
            </tr>
          </thead>

          <tbody>
            {% for c in items %}
            <tr class="border-t border-gray-200 hover:bg-gray-50/60">
              <td class="py-3 pl-4"></td>
              <td class="py-3">
                {% set display_name = c.name or (((c.first_name or '') ~ ' ' ~ (c.last_name or '')).strip()) %}
                <a class="text-title hover:underline"
                   href="{{ url_for('candidate_detail', tenant=tenant.slug if tenant else None, id=c.id) }}">
                  {{ display_name }}
                </a>
              </td>
              <td class="py-3">{{ c.job_title or (jd.title if jd else '-') }}</td>
              <td class="py-3">{{ c.department or '-' }}</td>

              <!-- Claim Validity chip -->
              <td class="py-3">
                {% set s = c.score %}
                {% if s is not none %}
                  {% set chip = 'bg-emerald-100 text-emerald-700' if s >= SCORE_GREEN
                                else ('bg-amber-100 text-amber-700' if s >= SCORE_YELLOW
                                      else 'bg-rose-100 text-rose-700') %}
                  <span class="inline-block min-w-[2.75rem] text-center px-2 py-0.5 rounded-full text-xs font-medium {{ chip }}">
                    {{ '%.2f'|format(s) }}
                  </span>
                {% else %}
                  <span class="text-slate/60">—</span>
                {% endif %}
              </td>

              <!-- Relevancy chip -->
              <td class="py-3">
                {% set r = c.relevancy %}
                {% set chip_r = 'bg-emerald-100 text-emerald-700' if r >= REL_GREEN
                                else ('bg-amber-100 text-amber-700' if r >= REL_YELLOW
                                      else 'bg-rose-100 text-rose-700') %}
                <span class="inline-block min-w-[2.5rem] text-center px-2 py-0.5 rounded-full text-xs font-medium {{ chip_r }}">
                  {{ '%.2f'|format(r) }}
                </span>
              </td>

              <td class="py-3">
                {% if c.applied_at %}
                  {{ c.applied_at.strftime('%b %d, %Y') }}
                {% else %}
                  <span class="text-slate/60">—</span>
                {% endif %}
              </td>

              <td class="py-3 pr-4 text-right">
                <a class="text-blue-600 hover:underline"
                   href="{{ url_for('candidate_detail', tenant=tenant.slug if tenant else None, id=c.id) }}">View</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-center gap-6 px-2 py-4">
        {% if page > 1 %}
          <a class="inline-flex items-center gap-1 hover:text-title"
             href="{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None, q=q, sort=sort, dir=dir, page=page-1) }}">
            ← Previous
          </a>
        {% else %}
          <span class="opacity-40">← Previous</span>
        {% endif %}

        <div class="flex items-center gap-0.5">
          {% for p in range(1, pages + 1) %}
            <a href="{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None, q=q, sort=sort, dir=dir, page=p) }}"
               class="min-w-[2rem] text-center rounded-md px-2 py-1 text-sm {{ 'bg-gray-900 text-white' if p==page else 'hover:bg-gray-100 text-title' }}">
              {{ p }}
            </a>
          {% endfor %}
        </div>

        {% if page < pages %}
          <a class="inline-flex items-center gap-1 hover:text-title"
             href="{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None, q=q, sort=sort, dir=dir, page=page+1) }}">
            Next →
          </a>
        {% else %}
          <span class="opacity-40">Next →</span>
        {% endif %}
      </div>
    </div>
  </div>

  {% endif %}
</div>
{% endblock %}
