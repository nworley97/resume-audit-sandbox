{% extends "base_app.html" %}
{% block title %}{% if jd %}Candidates – {{ jd.title }}{% else %}Candidates Overview - ALTERA{% endif %}{% endblock %}
{% block content %}
<div class="space-y-4">

  <!-- Header -->
  <div class="flex items-start justify-between mb-4">
    <div>
      <div class="flex items-center gap-2 text-slate text-sm mb-2">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
          <path d="M16 11c1.657 0 3-1.79 3-4s-1.343-4-3-4-3 1.79-3 4 1.343 4 3 4Z"></path>
          <path d="M8 12c1.657 0 3-1.79 3-4S9.657 4 8 4 5 5.79 5 8s1.343 4 3 4Z"></path>
          <path d="M2 20c0-2.761 2.91-5 6.5-5S15 17.239 15 20"></path>
          <path d="M15 15.5c3.59 0 6.5 2.239 6.5 5"></path>
        </svg>
        <span>Candidates</span>
      </div>
      <h1 class="text-2xl font-semibold text-title">
        {% if jd %}Candidates for {{ jd.title }}{% else %}Candidates Overview{% endif %}
      </h1>
      <p class="text-slate mt-1">
        {% if jd %}Manage and review candidate applications for this job
        {% else %}Manage and review candidate applications with intelligent insights{% endif %}
      </p>
    </div>
  </div>

  {% if (total or 0) == 0 %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
      <div class="p-12 text-center text-slate">
        {% if has_active_filters %}
          <div class="text-title text-lg mb-2">No candidates match these filters</div>
          <div class="text-sm mb-6">Adjust your filters or reset to view all candidates.</div>
          <a href="{% if jd %}{{ url_for('view_candidates', tenant=tenant.slug if tenant else None, code=jd.code) }}{% else %}{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None) }}{% endif %}"
             class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">
            Reset
          </a>
        {% else %}
          <div class="text-title text-lg mb-2">No applicants yet</div>
          <div class="text-sm mb-6">Once candidates apply, they’ll appear here for review and scoring.</div>
          <a href="{{ url_for('recruiter', tenant=tenant.slug if tenant else None) }}"
             class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">
            View Job Postings
          </a>
        {% endif %}
      </div>
    </div>
  {% else %}

  <div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="flex items-center justify-between gap-3 p-4 border-b border-gray-200">
      <form action="{% if jd %}{{ url_for('view_candidates', tenant=tenant.slug if tenant else None, code=jd.code) }}{% else %}{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None) }}{% endif %}"
            method="get" class="w-full max-w-md">
        <input type="hidden" name="sort" value="{{ sort or '' }}">
        <input type="hidden" name="dir"  value="{{ dir  or '' }}">
        <input type="hidden" name="page" value="1">
        <div class="relative">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate/70">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <circle cx="11" cy="11" r="7"></circle><path d="M20 20L17 17"></path>
            </svg>
          </span>
          <input class="w-full rounded-lg border border-gray-300 pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                 type="text" name="q" value="{{ q or '' }}" placeholder="Name, Job Title, JD Code, Department"/>
        </div>
      </form>

      <div class="flex items-center gap-2">
        <button id="filters-btn" class="inline-flex items-center gap-2 rounded-lg border border-gray-300 text-sm px-3 py-2 hover:bg-gray-50">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M3 5h18M6 12h12M10 19h4" stroke-linecap="round"/>
          </svg>
          Filter
        </button>
        <a href="{% if jd %}{{ url_for('export_candidates_csv', tenant=tenant_slug, q=jd.code) }}{% else %}{{ url_for('export_candidates_csv', tenant=tenant_slug) }}{% endif %}"
           class="inline-flex items-center gap-2 rounded-lg border border-gray-300 text-sm px-3 py-2 hover:bg-gray-50">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M12 3v12M7 10l5 5 5-5" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="4" y="17" width="16" height="4" rx="1.5"></rect>
          </svg>
          Export
        </a>


{# If you prefer the legacy endpoint, use this instead: #}
{# <a href="{{ url_for('candidates_export_csv', tenant=tenant_slug) }}">Export</a> #}

      </div>
    </div>

    {% macro sort_link(label, key) -%}
      {% set base = 'view_candidates' if jd else 'candidates_overview' %}
      {% set active = (sort==key) %}
      {% set asc = (active and dir=='asc') %}
      {% set desc = (active and dir=='desc') %}
      <div class="inline-flex items-center gap-1">
        <span>{{ label }}</span>
        <span class="flex flex-col leading-none ml-1">
          <a class="h-2 {{ 'text-title' if asc else 'text-slate/40' }}"
             href="{% if jd %}{{ url_for(base, tenant=tenant.slug if tenant else None, code=jd.code, q=q, page=1, sort=key, dir='asc') }}{% else %}{{ url_for(base, tenant=tenant.slug if tenant else None, q=q, page=1, sort=key, dir='asc') }}{% endif %}">
            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M6 14l6-6 6 6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
          <a class="h-2 {{ 'text-title' if desc else 'text-slate/40' }}"
             href="{% if jd %}{{ url_for(base, tenant=tenant.slug if tenant else None, code=jd.code, q=q, page=1, sort=key, dir='desc') }}{% else %}{{ url_for(base, tenant=tenant.slug if tenant else None, q=q, page=1, sort=key, dir='desc') }}{% endif %}">
            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M6 10l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </span>
      </div>
    {%- endmacro %}

    <div class="px-2 pb-2">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-slate border-y border-gray-200">
              <th class="text-left font-medium py-3 pl-4 w-10">
                <input id="select-all" type="checkbox" class="rounded border-gray-300">
              </th>
              <th class="text-left font-medium py-3 w-56">{{ sort_link('Name', 'name') }}</th>
              <th class="text-left font-medium py-3 w-48">{{ sort_link('Job Title', 'job') }}</th>
              <th class="text-left font-medium py-3 w-44">{{ sort_link('Department', 'dept') }}</th>
              <th class="text-left font-medium py-3 w-32">{{ sort_link('Claim Validity', 'score') }}</th>
              <th class="text-left font-medium py-3 w-32">{{ sort_link('Relevancy Score', 'relevancy') }}</th>
              <th class="text-left font-medium py-3 w-40">{{ sort_link('Date of Application', 'applied') }}</th>
              <th class="py-3 w-16"></th>
            </tr>
          </thead>

          <tbody>
            {% for c in items %}
            <tr class="border-t border-gray-200 hover:bg-gray-50/60">
              <td class="py-3 pl-4">
                  <input type="checkbox" class="rounded border-gray-300 row-check" name="sel" value="{{ c.id }}">
              </td>

              <td class="py-3">
                {% set display_name = c.name or (((c.first_name or '') ~ ' ' ~ (c.last_name or '')).strip()) %}
                {% if has_candidate_detail %}
                  <a class="text-title underline underline-offset-2 decoration-slate-300 transition-colors hover:text-primary hover:decoration-primary"
                     href="{{ url_for('candidate_detail', tenant=tenant.slug if tenant else None, id=c.id) }}">
                    {{ display_name }}
                  </a>
                {% else %}
                  <span class="text-title">{{ display_name }}</span>
                {% endif %}
              </td>

              <td class="py-3">{{ c.job_title or (jd.title if jd else '-') }}</td>
              <td class="py-3">{{ c.department or '-' }}</td>

              <!-- Claim Validity chip (0–5) -->
              <td class="py-3">
                {% set raw_scores = c.answer_scores or [] %}
                {% set cleaned_scores = raw_scores | reject('equalto', None) | list %}
                {% set ns = namespace(value=None) %}
                {% if c.score is not none %}
                  {% set ns.value = c.score %}
                {% elif cleaned_scores %}
                  {% set ns.value = (cleaned_scores|sum) / (cleaned_scores|length) %}
                {% endif %}
                {% set s = ns.value %}
                {% if s is not none %}
                  {% set chip = 'bg-emerald-100 text-emerald-700' if s >= SCORE_GREEN
                                else ('bg-amber-100 text-amber-700' if s >= SCORE_YELLOW
                                      else 'bg-rose-100 text-rose-700') %}
                  <span class="inline-block min-w-[1.9rem] text-center px-1.5 py-0.5 rounded-full text-[11px] font-medium {{ chip }}">
                    {{ '%.1f'|format(s) }}/5
                  </span>
                {% else %}
                  <span class="text-slate/60">—</span>
                {% endif %}
              </td>

              <!-- Relevancy chip (0–5) -->
              <td class="py-3">
                {% set r = c.relevancy if c.relevancy is not none else (c.fit_score if c.fit_score is not none else ((c.resume_json or {}).get('fit_score') or 0)) %}
                {% set chip_r = 'bg-emerald-100 text-emerald-700' if r >= REL_GREEN
                                else ('bg-amber-100 text-amber-700' if r >= REL_YELLOW
                                      else 'bg-rose-100 text-rose-700') %}
                <span class="inline-block min-w-[1.9rem] text-center px-1.5 py-0.5 rounded-full text-[11px] font-medium {{ chip_r }}">
                  {{ '%.1f'|format(r) }}/5
                </span>
              </td>

              <td class="py-3">
                {% if c.applied_at %}{{ c.applied_at.strftime('%b %d, %Y') }}{% else %}<span class="text-slate/60">—</span>{% endif %}
              </td>

              <td class="py-3 pr-4 text-right">
               <a class="text-blue-600 hover:underline"
                   href="{{ url_for('candidate_detail', tenant=tenant.slug if tenant else None, id=c.id) }}">View</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
<!-- Pagination (compact with ellipses) -->
<div class="px-2 py-4">
  {% set current = page|int %}
  {% set total = pages|int %}
  {% set window = 2 %}
  {% set base = 'view_candidates' if jd else 'candidates_overview' %}
  {% if total > 1 %}
  <nav class="flex items-center justify-center gap-2" role="navigation" aria-label="Pagination">
    {# Prev #}
    {% if current > 1 %}
      <a href="{% if jd %}{{ url_for(base, tenant=tenant.slug if tenant else None, code=jd.code, q=q, sort=sort, dir=dir, page=current-1) }}{% else %}{{ url_for(base, tenant=tenant.slug if tenant else None, q=q, sort=sort, dir=dir, page=current-1) }}{% endif %}"
         class="inline-flex items-center rounded-md border border-gray-300 px-2.5 py-1.5 text-xs hover:bg-gray-50"
         aria-label="Previous page">Prev</a>
    {% else %}
      <span class="inline-flex items-center rounded-md border border-gray-200 px-2.5 py-1.5 text-xs text-gray-400 cursor-not-allowed"
            aria-disabled="true">Prev</span>
    {% endif %}

    {# Page numbers with ellipses #}
    {% set last = 0 %}
    {% for i in range(1, total + 1) %}
      {% if i == 1 or i == total or (i >= current - window and i <= current + window) %}
        {% if last and i - last > 1 %}
          <span class="px-1 text-gray-400 select-none">…</span>
        {% endif %}
        {% if i == current %}
          <span class="inline-flex items-center rounded-md bg-blue-600 text-white px-2.5 py-1.5 text-xs">{{ i }}</span>
        {% else %}
          <a href="{% if jd %}{{ url_for(base, tenant=tenant.slug if tenant else None, code=jd.code, q=q, sort=sort, dir=dir, page=i) }}{% else %}{{ url_for(base, tenant=tenant.slug if tenant else None, q=q, sort=sort, dir=dir, page=i) }}{% endif %}"
             class="inline-flex items-center rounded-md border border-gray-300 px-2.5 py-1.5 text-xs hover:bg-gray-50">
            {{ i }}
          </a>
        {% endif %}
        {% set last = i %}
      {% endif %}
    {% endfor %}

    {# Next #}
    {% if current < total %}
      <a href="{% if jd %}{{ url_for(base, tenant=tenant.slug if tenant else None, code=jd.code, q=q, sort=sort, dir=dir, page=current+1) }}{% else %}{{ url_for(base, tenant=tenant.slug if tenant else None, q=q, sort=sort, dir=dir, page=current+1) }}{% endif %}"
         class="inline-flex items-center rounded-md border border-gray-300 px-2.5 py-1.5 text-xs hover:bg-gray-50"
         aria-label="Next page">Next</a>
    {% else %}
      <span class="inline-flex items-center rounded-md border border-gray-200 px-2.5 py-1.5 text-xs text-gray-400 cursor-not-allowed"
            aria-disabled="true">Next</span>
    {% endif %}
  </nav>
  {% endif %}
</div>

    </div>
  </div>

  {% endif %}
</div>

<!-- Filter Overlay -->
<div id="filter-overlay" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="filter-title">
  <div data-overlay class="absolute inset-0 bg-slate-900/40"></div>
  <div class="relative w-full sm:w-11/12 md:w-4/5 lg:w-1/2 xl:w-5/12 max-h-[65vh] rounded-2xl bg-white shadow-lg shadow-slate-900/10 overflow-hidden">
    <form id="filter-form"
          action="{% if jd %}{{ url_for('view_candidates', tenant=tenant.slug if tenant else None, code=jd.code) }}{% else %}{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None) }}{% endif %}"
          method="get"
          class="flex h-full max-h-[65vh] flex-col">
      <input type="hidden" name="q" value="{{ q or '' }}">
      <input type="hidden" name="sort" value="{{ sort or '' }}">
      <input type="hidden" name="dir" value="{{ dir or '' }}">
      <input type="hidden" name="page" value="1">

      <div class="flex items-start justify-between border-b border-gray-200 px-6 py-4">
        <div>
          <h2 id="filter-title" class="text-lg font-semibold text-title">Filter Candidates</h2>
        </div>
        <button type="button" id="close-filter" class="text-slate hover:text-title">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div data-scrollable class="flex-1 overflow-y-auto px-6 py-6 space-y-8">
        <!-- Job Title Filter -->
        <section class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-title uppercase tracking-wide">Job Title</h3>
          </div>
          <div class="rounded-xl border border-gray-200">
            <div class="max-h-48 overflow-y-auto divide-y divide-gray-100">
              {% set selected_job_titles = request.args.getlist('job_title') %}
              {% if job_titles %}
                {% for title in job_titles|sort %}
                  <label class="flex items-center justify-between gap-3 px-4 py-3 text-sm text-title hover:bg-gray-50 cursor-pointer">
                    <span class="inline-flex items-center gap-3">
                      <input type="checkbox" name="job_title" value="{{ title }}"
                             class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                             {% if title in selected_job_titles %}checked{% endif %}>
                      <span>{{ title }}</span>
                    </span>
                  </label>
                {% endfor %}
              {% else %}
                <div class="px-4 py-6 text-sm text-slate">No job title metadata yet.</div>
              {% endif %}
            </div>
          </div>
        </section>

        <!-- Department Filter -->
        <section class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-title uppercase tracking-wide">Department</h3>
          </div>
          <div class="rounded-xl border border-gray-200">
            <div class="max-h-48 overflow-y-auto divide-y divide-gray-100">
              {% set selected_departments = request.args.getlist('department') %}
              {% if departments %}
                {% for dept in departments|sort %}
                  <label class="flex items-center justify-between gap-3 px-4 py-3 text-sm text-title hover:bg-gray-50 cursor-pointer">
                    <span class="inline-flex items-center gap-3">
                      <input type="checkbox" name="department" value="{{ dept }}"
                             class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                             {% if dept in selected_departments %}checked{% endif %}>
                      <span>{{ dept }}</span>
                    </span>
                  </label>
                {% endfor %}
              {% else %}
                <div class="px-4 py-6 text-sm text-slate">No department metadata yet.</div>
              {% endif %}
            </div>
          </div>
        </section>

        <!-- Claim Validity Score Filter -->
        <section class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-title uppercase tracking-wide">Claim Validity Score</h3>
          </div>
          <div class="grid gap-2 sm:grid-cols-2">
            {% set claim_selected = request.args.get('claim_validity_min') %}
            <label class="flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm hover:border-primary/60 cursor-pointer">
              <input type="radio" name="claim_validity_min" value="5.0"
                     class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                     {% if claim_selected == '5.0' %}checked{% endif %}>
              <span class="text-title">Score 5 or higher</span>
            </label>
            <label class="flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm hover:border-primary/60 cursor-pointer">
              <input type="radio" name="claim_validity_min" value="4.0"
                     class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                     {% if claim_selected == '4.0' %}checked{% endif %}>
              <span class="text-title">Score 4 or higher</span>
            </label>
            <label class="flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm hover:border-primary/60 cursor-pointer">
              <input type="radio" name="claim_validity_min" value="3.0"
                     class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                     {% if claim_selected == '3.0' %}checked{% endif %}>
              <span class="text-title">Score 3 or higher</span>
            </label>
          </div>
        </section>

        <!-- Relevancy Score Filter -->
        <section class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-title uppercase tracking-wide">Relevancy Score</h3>
          </div>
          <div class="grid gap-2 sm:grid-cols-2">
            {% set relevancy_selected = request.args.get('relevancy_min') %}
            <label class="flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm hover:border-primary/60 cursor-pointer">
              <input type="radio" name="relevancy_min" value="5.0"
                     class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                     {% if relevancy_selected == '5.0' %}checked{% endif %}>
              <span class="text-title">Score 5 or higher</span>
            </label>
            <label class="flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm hover:border-primary/60 cursor-pointer">
              <input type="radio" name="relevancy_min" value="4.0"
                     class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                     {% if relevancy_selected == '4.0' %}checked{% endif %}>
              <span class="text-title">Score 4 or higher</span>
            </label>
            <label class="flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm hover:border-primary/60 cursor-pointer">
              <input type="radio" name="relevancy_min" value="3.0"
                     class="h-4 w-4 border-gray-300 text-primary focus:ring-primary"
                     {% if relevancy_selected == '3.0' %}checked{% endif %}>
              <span class="text-title">Score 3 or higher</span>
            </label>
          </div>
        </section>

        <!-- Date Range Filter -->
        <section class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-title uppercase tracking-wide">Date of Application</h3>
          </div>
          <div class="grid gap-4 sm:grid-cols-2">
            <div class="space-y-2">
              <label class="text-xs font-medium text-slate uppercase tracking-wide">From</label>
              <input type="date" name="date_from" value="{{ request.args.get('date_from', '') }}"
                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="space-y-2">
              <label class="text-xs font-medium text-slate uppercase tracking-wide">To</label>
              <input type="date" name="date_to" value="{{ request.args.get('date_to', '') }}"
                     class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button type="button" class="date-preset text-xs px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-50" data-preset="today">Today</button>
            <button type="button" class="date-preset text-xs px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-50" data-preset="7">Last 7 days</button>
            <button type="button" class="date-preset text-xs px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-50" data-preset="14">Last 14 days</button>
            <button type="button" class="date-preset text-xs px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-50" data-preset="30">Last 30 days</button>
          </div>
        </section>
      </div>

      <div class="flex items-center justify-between gap-3 border-t border-gray-200 px-6 py-4 bg-gray-50">
        <a href="{% if jd %}{{ url_for('view_candidates', tenant=tenant.slug if tenant else None, code=jd.code, q=q, sort=sort, dir=dir) }}{% else %}{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None, q=q, sort=sort, dir=dir) }}{% endif %}"
           class="text-sm font-medium text-primary hover:text-primary/80">Reset</a>
        <div class="flex items-center gap-3">
          <button type="button" id="cancel-filter"
                  class="rounded-lg border border-gray-300 px-4 py-2 text-sm text-title hover:bg-gray-100">Cancel</button>
          <button type="submit" class="rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary/90">
            Apply
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
(function () {
  const all = document.getElementById('select-all');
  const rows = () => Array.from(document.querySelectorAll('input.row-check'));
  all?.addEventListener('change', () => rows().forEach(cb => { cb.checked = all.checked; }));
})();

// Filter overlay functionality
(function () {
  const filterBtn = document.getElementById('filters-btn');
  const filterOverlay = document.getElementById('filter-overlay');
  const closeFilter = document.getElementById('close-filter');
  const cancelFilter = document.getElementById('cancel-filter');
  const filterForm = document.getElementById('filter-form');
  const overlayBackdrop = filterOverlay?.querySelector('[data-overlay]');
  const scrollRegion = filterOverlay?.querySelector('[data-scrollable]');

  if (!filterBtn || !filterOverlay) return;

  const lockScroll = () => {
    const scrollY = window.scrollY || window.pageYOffset || 0;
    document.body.dataset.scrollY = String(scrollY);
    document.body.style.top = `-${scrollY}px`;
    document.body.classList.add('fixed', 'w-full', 'overflow-hidden');
  };

  const unlockScroll = () => {
    const scrollY = parseInt(document.body.dataset.scrollY || '0', 10);
    document.body.classList.remove('fixed', 'w-full', 'overflow-hidden');
    document.body.style.removeProperty('top');
    window.scrollTo(0, scrollY);
    delete document.body.dataset.scrollY;
  };

  const open = (event) => {
    event?.preventDefault();
    filterOverlay.classList.remove('hidden');
    lockScroll();
  };

  const close = () => {
    filterOverlay.classList.add('hidden');
    unlockScroll();
  };

  filterBtn.addEventListener('click', open);
  closeFilter?.addEventListener('click', close);
  cancelFilter?.addEventListener('click', close);
  overlayBackdrop?.addEventListener('click', close);

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && !filterOverlay.classList.contains('hidden')) {
      close();
    }
  });

  if (scrollRegion) {
    const stop = (event) => event.stopPropagation();
    scrollRegion.addEventListener('wheel', stop, { passive: true });
    scrollRegion.addEventListener('touchmove', stop, { passive: true });
  }

  filterOverlay.querySelectorAll('.date-preset').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!filterForm) return;
      const preset = btn.dataset.preset;
      const today = new Date();
      const dateFrom = filterForm.querySelector('input[name="date_from"]');
      const dateTo = filterForm.querySelector('input[name="date_to"]');
      if (!dateFrom || !dateTo) return;

      if (preset === 'today') {
        const todayStr = today.toISOString().split('T')[0];
        dateFrom.value = todayStr;
        dateTo.value = todayStr;
      } else {
        const days = parseInt(preset || '0', 10);
        if (Number.isNaN(days)) return;
        const fromDate = new Date(today);
        fromDate.setDate(today.getDate() - days);
        dateFrom.value = fromDate.toISOString().split('T')[0];
        dateTo.value = today.toISOString().split('T')[0];
      }
    });
  });
})();
</script>

{% endblock %}
