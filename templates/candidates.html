{% extends "base_app.html" %}
{% block title %}{% if jd %}Candidates – {{ jd.title }}{% else %}Candidates Overview - ALTERA{% endif %}{% endblock %}
{% block content %}
<div class="space-y-4">

  <!-- Header -->
  <div class="flex items-start justify-between mb-4">
    <div>
      <div class="flex items-center gap-2 text-slate text-sm mb-2">
        <!-- Match sidebar Candidates icon -->
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M18 21a8 8 0 0 0-16 0"></path>
          <circle cx="10" cy="8" r="5"></circle>
          <path d="M22 20c0-3.37-2-6.5-4-8a5 5 0 0 0-.45-8.3"></path>
        </svg>
        <span>Candidates</span>
      </div>
      <h1 class="text-2xl font-semibold text-title">
        {% if jd %}Candidates for {{ jd.title }}{% else %}Candidates Overview{% endif %}
      </h1>
      <p class="text-slate mt-1">
        {% if jd %}Manage and review candidate applications for this job
        {% else %}Manage and review candidate applications with intelligent insights{% endif %}
      </p>
    </div>
  </div>

  {% if (total or 0) == 0 %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
      <div class="p-12 text-center text-slate">
        {% if has_active_filters %}
          <div class="text-title text-lg mb-2">No candidates match these filters</div>
          <div class="text-sm mb-6">Adjust your filters or reset to view all candidates.</div>
          <a href="{% if jd %}{{ url_for('view_candidates', tenant=tenant.slug if tenant else None, code=jd.code) }}{% else %}{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None) }}{% endif %}"
             class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">
            Reset
          </a>
        {% else %}
          <div class="text-title text-lg mb-2">No applicants yet</div>
          <div class="text-sm mb-6">Once candidates apply, they’ll appear here for review and scoring.</div>
          <a href="{{ url_for('recruiter', tenant=tenant.slug if tenant else None) }}"
             class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">
            View Job Postings
          </a>
        {% endif %}
      </div>
    </div>
  {% else %}

  <div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="flex items-center justify-between gap-3 p-4 border-b border-gray-200">
      <form action="{% if jd %}{{ url_for('view_candidates', tenant=tenant.slug if tenant else None, code=jd.code) }}{% else %}{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None) }}{% endif %}"
            method="get" class="w-full max-w-md">
        <input type="hidden" name="sort" value="{{ sort or '' }}">
        <input type="hidden" name="dir"  value="{{ dir  or '' }}">
        <input type="hidden" name="page" value="1">
        {% for key, values in request.args.lists() %}
          {% if key not in ['q', 'sort', 'dir', 'page'] %}
            {% for value in values %}
              <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endfor %}
          {% endif %}
        {% endfor %}
        <div class="relative">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate/70">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <circle cx="11" cy="11" r="7"></circle><path d="M20 20L17 17"></path>
            </svg>
          </span>
          <input class="w-full rounded-lg border border-gray-300 pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                 type="text" name="q" value="{{ q or '' }}" placeholder="Name, Job Title, JD Code, Department"/>
        </div>
      </form>

      <div class="flex items-center gap-2">
        {% set filter_count = active_filter_count|default(0) %}
        {% set has_filters = filter_count > 0 %}
        {% if has_filters %}
          <button type="button"
                  class="filter-reset-btn inline-flex items-center justify-center text-sm {{ 'text-primary hover:text-primary/80' if has_filters else 'text-title hover:text-title/70' }}"
                  data-reset-url="{{ query_url(page=1, job_title=None, department=None, claim_validity_min=None, claim_validity_max=None, relevancy_min=None, relevancy_max=None, date_from=None, date_to=None) }}"
                  aria-label="Reset filters">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="1 4 1 10 7 10"></polyline>
              <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
          </button>
        {% endif %}
        <button type="button"
                id="filters-btn"
                class="inline-flex items-center gap-2 rounded-lg border border-gray-300 text-sm px-3 py-2 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary {{ 'text-primary border-primary/50 bg-primary/5' if has_filters else 'text-title' }}">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M3 5h18M6 12h12M10 19h4" stroke-linecap="round"/>
          </svg>
          Filter
          {% if has_filters %}
            <span class="ml-1 inline-flex h-5 min-w-[1.4rem] items-center justify-center rounded-full bg-primary text-white text-[11px] font-medium px-1">
              {{ filter_count }}
            </span>
          {% endif %}
        </button>
        <a href="{% if jd %}{{ url_for('export_candidates_csv', tenant=tenant_slug, q=jd.code) }}{% else %}{{ url_for('export_candidates_csv', tenant=tenant_slug) }}{% endif %}"
           download
           class="inline-flex items-center gap-2 rounded-lg border border-gray-300 text-sm px-3 py-2 hover:bg-gray-50">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M12 3v12M7 10l5 5 5-5" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="4" y="17" width="16" height="4" rx="1.5"></rect>
          </svg>
          Export
        </a>


{# If you prefer the legacy endpoint, use this instead: #}
{# <a href="{{ url_for('candidates_export_csv', tenant=tenant_slug) }}">Export</a> #}

      </div>
    </div>

    {% macro sort_link(label, key) -%}
      {% set base = 'view_candidates' if jd else 'candidates_overview' %}
      {% set active = (sort==key) %}
      {% set asc = (active and dir=='asc') %}
      {% set desc = (active and dir=='desc') %}
      <div class="inline-flex items-center gap-1">
        <span>{{ label }}</span>
        <span class="flex flex-col leading-none ml-1">
          <a class="h-2 {{ 'text-title' if asc else 'text-slate/40' }}"
             href="{{ query_url(sort=key, dir='asc', page=1) }}">
            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M6 14l6-6 6 6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
          <a class="h-2 {{ 'text-title' if desc else 'text-slate/40' }}"
             href="{{ query_url(sort=key, dir='desc', page=1) }}">
            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M6 10l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </span>
      </div>
    {%- endmacro %}

    {% set overall_total = overall_total_count|default(total)|int %}
    {% set filtered_total = total|default(0)|int %}
    {% set overall_display = "{:,}".format(overall_total) %}
    {% set filtered_display = "{:,}".format(filtered_total) %}
    {% set show_filtered_counts = showing_filtered|default(False) %}

    <div class="border-t border-gray-100"></div>
    <div class="px-4 py-3 text-sm text-title/80">
      {% if show_filtered_counts %}
        Showing <span class="font-semibold text-title">{{ filtered_display }}</span> candidates
        out of <span class="font-semibold text-title">{{ overall_display }}</span>
      {% else %}
        <span class="font-semibold text-title">{{ overall_display }}</span> candidates
      {% endif %}
    </div>

    <div class="px-2 pb-2">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-slate border-y border-gray-200">
              <th class="text-left font-medium py-3 pl-4 w-10">
                <input id="select-all" type="checkbox" class="rounded border-gray-300">
              </th>
              <th class="text-left font-medium py-3 w-56">{{ sort_link('Name', 'name') }}</th>
              <th class="text-left font-medium py-3 w-48">{{ sort_link('Job Title', 'job') }}</th>
              <th class="text-left font-medium py-3 w-44">{{ sort_link('Department', 'dept') }}</th>
              <th class="text-left font-medium py-3 w-32">{{ sort_link('Claim Validity', 'score') }}</th>
              <th class="text-left font-medium py-3 w-32">{{ sort_link('Relevancy Score', 'relevancy') }}</th>
              <th class="text-left font-medium py-3 w-40">{{ sort_link('Date of Application', 'applied') }}</th>
              <th class="py-3 w-16"></th>
            </tr>
          </thead>

          <tbody>
            {% for c in items %}
            <tr class="border-t border-gray-200 hover:bg-gray-50/60">
              <td class="py-3 pl-4">
                  <input type="checkbox" class="rounded border-gray-300 row-check" name="sel" value="{{ c.id }}">
              </td>

              <td class="py-3">
                {% set display_name = c.name or (((c.first_name or '') ~ ' ' ~ (c.last_name or '')).strip()) %}
                {% if has_candidate_detail %}
                  <a class="text-title underline underline-offset-2 decoration-slate-300 transition-colors hover:text-primary hover:decoration-primary"
                     href="{{ url_for('candidate_detail', tenant=tenant.slug if tenant else None, id=c.id) }}">
                    {{ display_name }}
                  </a>
                {% else %}
                  <span class="text-title">{{ display_name }}</span>
                {% endif %}
              </td>

              <td class="py-3">{{ c.job_title or (jd.title if jd else '-') }}</td>
              <td class="py-3">{{ c.department or '-' }}</td>

              <!-- Claim Validity chip (0–5) -->
              <td class="py-3">
                {% set raw_scores = c.answer_scores or [] %}
                {% set cleaned_scores = raw_scores | reject('equalto', None) | list %}
                {% set ns = namespace(value=None) %}
                {% if c.score is not none %}
                  {% set ns.value = c.score %}
                {% elif cleaned_scores %}
                  {% set ns.value = (cleaned_scores|sum) / (cleaned_scores|length) %}
                {% endif %}
                {% set s = ns.value %}
                {% if s is not none %}
                  {% set chip = 'bg-emerald-100 text-emerald-700' if s >= SCORE_GREEN
                                else ('bg-amber-100 text-amber-700' if s >= SCORE_YELLOW
                                      else 'bg-rose-100 text-rose-700') %}
                  <span class="inline-block min-w-[1.9rem] text-center px-1.5 py-0.5 rounded-full text-[11px] font-medium {{ chip }}">
                    {{ '%.1f'|format(s) }}/5
                  </span>
                {% else %}
                  <span class="text-slate/60">—</span>
                {% endif %}
              </td>

              <!-- Relevancy chip (0–5) -->
              <td class="py-3">
                {% set r = c.relevancy if c.relevancy is not none else (c.fit_score if c.fit_score is not none else ((c.resume_json or {}).get('fit_score') or 0)) %}
                {% set chip_r = 'bg-emerald-100 text-emerald-700' if r >= REL_GREEN
                                else ('bg-amber-100 text-amber-700' if r >= REL_YELLOW
                                      else 'bg-rose-100 text-rose-700') %}
                <span class="inline-block min-w-[1.9rem] text-center px-1.5 py-0.5 rounded-full text-[11px] font-medium {{ chip_r }}">
                  {{ '%.1f'|format(r) }}/5
                </span>
              </td>

              <td class="py-3">
                {% if c.applied_at %}{{ c.applied_at.strftime('%b %d, %Y') }}{% else %}<span class="text-slate/60">—</span>{% endif %}
              </td>

              <td class="py-3 pr-4 text-right">
               <a class="text-blue-600 hover:underline"
                   href="{{ url_for('candidate_detail', tenant=tenant.slug if tenant else None, id=c.id) }}">View</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% set current = page|int %}
      {% set total = pages|int %}
      {% set window = 2 %}

      {% if total > 1 %}
        {% set ns = namespace(list=[]) %}
        {% set _ = ns.list.append(1) %}
        {% for i in range(current-window, current+window+1) %}
          {% if 1 < i < total %}
            {% set _ = ns.list.append(i) %}
          {% endif %}
        {% endfor %}
        {% set _ = ns.list.append(total) %}
        {% set pages_compact = ns.list|unique|sort %}

        <nav class="flex items-center justify-center gap-1 sm:gap-2 px-2 py-4"
             role="navigation"
             aria-label="Pagination">

          {# Prev #}
          {% if current > 1 %}
            <a href="{{ page_url(current-1) }}"
               rel="prev"
               class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-2.5 py-1.5 text-xs text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-teal-500"
               aria-label="Previous page">&lt;</a>
          {% else %}
            <span class="inline-flex items-center rounded-lg border border-slate-200 bg-slate-50 px-2.5 py-1.5 text-xs text-slate-400 cursor-not-allowed"
                  aria-disabled="true">&lt;</span>
          {% endif %}

          {# Pages with ellipses #}
          {% set last = None %}
          {% for p in pages_compact %}
            {% if last is not none and p - last > 1 %}
              <span class="px-2 text-slate-400 select-none" aria-hidden="true">...</span>
            {% endif %}

            {% if p == current %}
              <span class="inline-flex items-center rounded-lg text-white px-2.5 py-1.5 text-xs shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
                    style="background-color:#009689"
                    aria-current="page">{{ p }}</span>
            {% else %}
              <a href="{{ page_url(p) }}"
                 class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-2.5 py-1.5 text-xs text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-teal-500">
                {{ p }}
              </a>
            {% endif %}
            {% set last = p %}
          {% endfor %}

          {# Next #}
          {% if current < total %}
            <a href="{{ page_url(current+1) }}"
               rel="next"
               class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-2.5 py-1.5 text-xs text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-teal-500"
               aria-label="Next page">&gt;</a>
          {% else %}
            <span class="inline-flex items-center rounded-lg border border-slate-200 bg-slate-50 px-2.5 py-1.5 text-xs text-slate-400 cursor-not-allowed"
                  aria-disabled="true">&gt;</span>
          {% endif %}
        </nav>
      {% endif %}

    </div>
  </div>

  {% endif %}
</div>

<!-- Filter Overlay -->
<div id="filter-overlay" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="filter-title">
  <div data-overlay class="absolute inset-0 bg-slate-900/40"></div>
  <div class="relative w-full sm:w-11/12 md:w-4/5 lg:w-1/2 xl:w-5/12 max-h-[65vh] rounded-2xl bg-white shadow-lg shadow-slate-900/10 overflow-hidden">
    <form id="filter-form"
          action="{% if jd %}{{ url_for('view_candidates', tenant=tenant.slug if tenant else None, code=jd.code) }}{% else %}{{ url_for('candidates_overview', tenant=tenant.slug if tenant else None) }}{% endif %}"
          method="get"
          class="flex h-full max-h-[65vh] flex-col">
      <input type="hidden" name="q" value="{{ q or '' }}">
      <input type="hidden" name="sort" value="{{ sort or '' }}">
      <input type="hidden" name="dir" value="{{ dir or '' }}">
      <input type="hidden" name="page" value="1">

      <div class="flex items-start justify-between border-b border-gray-200 px-6 py-4">
        <div>
          <h2 id="filter-title" class="text-lg font-semibold text-title">Filter Candidates</h2>
        </div>
        <button type="button" id="close-filter" class="text-slate hover:text-title">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div data-scrollable class="flex-1 overflow-y-auto px-6 py-6 space-y-8">
        <!-- Job Title Filter -->
        <section class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-title uppercase tracking-wide">Job Title</h3>
          </div>
          <div class="rounded-xl border border-gray-200">
            <div class="max-h-48 overflow-y-auto divide-y divide-gray-100">
              {% set selected_job_titles = request.args.getlist('job_title') %}
              {% if job_titles %}
                {% for title in job_titles|sort %}
                  <label class="flex items-center justify-between gap-3 px-4 py-3 text-sm text-title hover:bg-gray-50 cursor-pointer">
                    <span class="inline-flex items-center gap-3">
                      <input type="checkbox" name="job_title" value="{{ title }}"
                             class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                             {% if title in selected_job_titles %}checked{% endif %}>
                      <span>{{ title }}</span>
                    </span>
                  </label>
                {% endfor %}
              {% else %}
                <div class="px-4 py-6 text-sm text-slate">No job title metadata yet.</div>
              {% endif %}
            </div>
          </div>
        </section>

        <!-- Department Filter -->
        <section class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-title uppercase tracking-wide">Department</h3>
          </div>
          <div class="rounded-xl border border-gray-200">
            <div class="max-h-48 overflow-y-auto divide-y divide-gray-100">
              {% set selected_departments = request.args.getlist('department') %}
              {% if departments %}
                {% for dept in departments|sort %}
                  <label class="flex items-center justify-between gap-3 px-4 py-3 text-sm text-title hover:bg-gray-50 cursor-pointer">
                    <span class="inline-flex items-center gap-3">
                      <input type="checkbox" name="department" value="{{ dept }}"
                             class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                             {% if dept in selected_departments %}checked{% endif %}>
                      <span>{{ dept }}</span>
                    </span>
                  </label>
                {% endfor %}
              {% else %}
                <div class="px-4 py-6 text-sm text-slate">No department metadata yet.</div>
              {% endif %}
            </div>
          </div>
        </section>

        <!-- Claim Validity Score Filter -->
        <section class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-title uppercase tracking-wide">Claim Validity Score</h3>
          </div>
          {% set claim_min_arg = request.args.get('claim_validity_min') %}
          {% set claim_max_arg = request.args.get('claim_validity_max') %}
          {% set claim_min_value = '%.1f'|format((claim_min_arg if claim_min_arg is not none else 0)|float) %}
          {% set claim_max_value = '%.1f'|format((claim_max_arg if claim_max_arg is not none else 5)|float) %}
          <div class="space-y-2">
            <div class="flex items-center justify-between text-xs text-slate">
              <span>Selected range</span>
              <span data-range-display="claim" class="font-medium text-title text-sm">{{ claim_min_value }} – {{ claim_max_value }}</span>
            </div>
            <div class="slider-range slider-range--claim" data-range-group="claim" data-default-min="0" data-default-max="5">
              <div class="slider-range__track"></div>
              <div class="slider-range__range"></div>
              <input type="range"
                     class="slider-range__input slider-range__input--min"
                     name="claim_validity_min"
                     min="0" max="5" step="0.1"
                     value="{{ claim_min_value }}"
                     data-role="min">
              <input type="range"
                     class="slider-range__input slider-range__input--max"
                     name="claim_validity_max"
                     min="0" max="5" step="0.1"
                     value="{{ claim_max_value }}"
                     data-role="max">
            </div>
          </div>
        </section>

        <!-- Relevancy Score Filter -->
        <section class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-title uppercase tracking-wide">Relevancy Score</h3>
          </div>
          {% set relevancy_min_arg = request.args.get('relevancy_min') %}
          {% set relevancy_max_arg = request.args.get('relevancy_max') %}
          {% set relevancy_min_value = '%.1f'|format((relevancy_min_arg if relevancy_min_arg is not none else 0)|float) %}
          {% set relevancy_max_value = '%.1f'|format((relevancy_max_arg if relevancy_max_arg is not none else 5)|float) %}
          <div class="space-y-2">
            <div class="flex items-center justify-between text-xs text-slate">
              <span>Selected range</span>
              <span data-range-display="relevancy" class="font-medium text-title text-sm">{{ relevancy_min_value }} – {{ relevancy_max_value }}</span>
            </div>
            <div class="slider-range slider-range--relevancy" data-range-group="relevancy" data-default-min="0" data-default-max="5">
              <div class="slider-range__track"></div>
              <div class="slider-range__range"></div>
              <input type="range"
                     class="slider-range__input slider-range__input--min"
                     name="relevancy_min"
                     min="0" max="5" step="0.1"
                     value="{{ relevancy_min_value }}"
                     data-role="min">
              <input type="range"
                     class="slider-range__input slider-range__input--max"
                     name="relevancy_max"
                     min="0" max="5" step="0.1"
                     value="{{ relevancy_max_value }}"
                     data-role="max">
            </div>
          </div>
        </section>

        <!-- Date Range Filter -->
        <section class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-title uppercase tracking-wide">Date of Application</h3>
          </div>
          <div class="grid gap-4 sm:grid-cols-2">
            <div class="space-y-2">
              <label class="text-xs font-medium text-slate uppercase tracking-wide">From</label>
              <input type="date" name="date_from" value="{{ request.args.get('date_from', '') }}"
                     class="filter-date-input w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="space-y-2">
              <label class="text-xs font-medium text-slate uppercase tracking-wide">To</label>
              <input type="date" name="date_to" value="{{ request.args.get('date_to', '') }}"
                     class="filter-date-input w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button type="button" class="date-preset text-xs px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-50" data-preset="today">Today</button>
            <button type="button" class="date-preset text-xs px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-50" data-preset="7">Last 7 days</button>
            <button type="button" class="date-preset text-xs px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-50" data-preset="14">Last 14 days</button>
            <button type="button" class="date-preset text-xs px-3 py-1 rounded-lg border border-gray-300 hover:bg-gray-50" data-preset="30">Last 30 days</button>
          </div>
        </section>
      </div>

      <div class="flex items-center justify-between gap-3 border-t border-gray-200 px-6 py-4 bg-gray-50">
        <button type="button"
                id="filters-reset"
                data-reset-url="{{ query_url(page=1, job_title=None, department=None, claim_validity_min=None, claim_validity_max=None, relevancy_min=None, relevancy_max=None, date_from=None, date_to=None, filter_overlay='1') }}"
                class="text-sm font-medium text-primary hover:text-primary/80">
          Reset
        </button>
        <div class="flex items-center gap-3">
          <button type="button" id="cancel-filter"
                  class="rounded-lg border border-gray-300 px-4 py-2 text-sm text-title hover:bg-gray-100">Cancel</button>
          <button type="submit" class="rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary/90">
            Apply
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<style>
  #filter-overlay .filter-date-input.filter-date-input--active {
    border-color: #0d9488;
    color: #0d9488;
  }
  #filter-overlay .date-preset.date-preset--active {
    border-color: #0d9488;
    background-color: rgba(13, 148, 136, 0.12);
    color: #0d9488;
  }
</style>

<script>
(function () {
  const all = document.getElementById('select-all');
  const rows = () => Array.from(document.querySelectorAll('input.row-check'));
  all?.addEventListener('change', () => rows().forEach(cb => { cb.checked = all.checked; }));
})();

// Filter overlay functionality
(function () {
  const filterBtn = document.getElementById('filters-btn');
  const filterOverlay = document.getElementById('filter-overlay');
  const closeFilter = document.getElementById('close-filter');
  const cancelFilter = document.getElementById('cancel-filter');
  const filterForm = document.getElementById('filter-form');
  const overlayBackdrop = filterOverlay?.querySelector('[data-overlay]');
  const scrollRegion = filterOverlay?.querySelector('[data-scrollable]');

  if (!filterBtn || !filterOverlay) return;

  const lockScroll = () => {
    const scrollY = window.scrollY || window.pageYOffset || 0;
    document.body.dataset.scrollY = String(scrollY);
    document.body.style.top = `-${scrollY}px`;
    document.body.classList.add('fixed', 'w-full', 'overflow-hidden');
  };

  const unlockScroll = () => {
    const scrollY = parseInt(document.body.dataset.scrollY || '0', 10);
    document.body.classList.remove('fixed', 'w-full', 'overflow-hidden');
    document.body.style.removeProperty('top');
    window.scrollTo(0, scrollY);
    delete document.body.dataset.scrollY;
  };

  const open = (event) => {
    event?.preventDefault();
    filterOverlay.classList.remove('hidden');
    lockScroll();
    if (window.__candidatesSyncDates) {
      window.__candidatesSyncDates();
    }
  };

  const close = () => {
    filterOverlay.classList.add('hidden');
    unlockScroll();
  };

  filterBtn.addEventListener('click', open);
  closeFilter?.addEventListener('click', close);
  cancelFilter?.addEventListener('click', close);
  overlayBackdrop?.addEventListener('click', close);

  const params = new URLSearchParams(window.location.search || '');
  if (params.get('filter_overlay') === '1') {
    open();
    params.delete('filter_overlay');
    const next = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
    window.history.replaceState({}, document.title, next);
  }

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && !filterOverlay.classList.contains('hidden')) {
      close();
    }
  });

  if (scrollRegion) {
    const stop = (event) => event.stopPropagation();
    scrollRegion.addEventListener('wheel', stop, { passive: true });
    scrollRegion.addEventListener('touchmove', stop, { passive: true });
  }

  filterOverlay.querySelectorAll('.date-preset').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!filterForm) return;
      const preset = btn.dataset.preset;
      const today = new Date();
      const dateFrom = filterForm.querySelector('input[name="date_from"]');
      const dateTo = filterForm.querySelector('input[name="date_to"]');
      if (!dateFrom || !dateTo) return;

      if (preset === 'today') {
        const todayStr = today.toISOString().split('T')[0];
        dateFrom.value = todayStr;
        dateTo.value = todayStr;
      } else {
        const days = parseInt(preset || '0', 10);
        if (Number.isNaN(days)) return;
        const fromDate = new Date(today);
        fromDate.setDate(today.getDate() - days);
        dateFrom.value = fromDate.toISOString().split('T')[0];
        dateTo.value = today.toISOString().split('T')[0];
      }
      if (window.__candidatesSyncDates) {
        window.__candidatesSyncDates();
      }
    });
  });
})();

(function () {
  if (!document.getElementById('slider-range-styles')) {
    const style = document.createElement('style');
    style.id = 'slider-range-styles';
    style.textContent = `
.slider-range {
  position: relative;
  width: 100%;
  padding: 0.75rem 0;
  --range-color: #10b981;
  --thumb-color: #059669;
  --thumb-hover: rgba(16,185,129,0.25);
}
.slider-range__track,
.slider-range__range {
  position: absolute;
  left: 0;
  right: 0;
  top: 50%;
  height: 0.5rem;
  border-radius: 9999px;
  transform: translateY(-50%);
}
.slider-range__track {
  background-color: #e2e8f0;
  z-index: 1;
}
.slider-range__range {
  background-color: var(--range-color);
  z-index: 2;
}
.slider-range__input {
  position: absolute;
  left: 0;
  right: 0;
  width: 100%;
  height: 0.5rem;
  margin: 0;
  background: transparent;
  pointer-events: none;
  -webkit-appearance: none;
  appearance: none;
}
.slider-range__input--min {
  z-index: 3;
}
.slider-range__input--max {
  z-index: 4;
}
.slider-range__input::-webkit-slider-thumb {
  pointer-events: auto;
  -webkit-appearance: none;
  appearance: none;
  width: 1.25rem;
  height: 1.25rem;
  border-radius: 9999px;
  background: var(--thumb-color);
  border: 2px solid #fff;
  box-shadow: 0 2px 6px rgba(15,23,42,0.3);
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.2s ease;
}
.slider-range__input::-moz-range-thumb {
  pointer-events: auto;
  width: 1.25rem;
  height: 1.25rem;
  border-radius: 9999px;
  background: var(--thumb-color);
  border: 2px solid #fff;
  box-shadow: 0 2px 6px rgba(15,23,42,0.3);
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.2s ease;
}
.slider-range__input::-webkit-slider-runnable-track {
  background: transparent;
}
.slider-range__input::-moz-range-track {
  background: transparent;
}
.slider-range__input::-webkit-slider-thumb:active,
.slider-range__input::-moz-range-thumb:active {
  transform: scale(1.08);
}
.slider-range:hover .slider-range__input::-webkit-slider-thumb,
.slider-range .slider-range__input:focus::-webkit-slider-thumb {
  box-shadow: 0 0 0 4px var(--thumb-hover), 0 2px 6px rgba(15,23,42,0.3);
}
.slider-range:hover .slider-range__input::-moz-range-thumb,
.slider-range .slider-range__input:focus::-moz-range-thumb {
  box-shadow: 0 0 0 4px var(--thumb-hover), 0 2px 6px rgba(15,23,42,0.3);
}
.slider-range--claim {
  --range-color: #0ea5e9;       /* sky-500 */
  --thumb-color: #0284c7;       /* sky-600 */
  --thumb-hover: rgba(14,165,233,0.25); /* sky-500 with alpha */
}

.slider-range--relevancy {
  --range-color: #a855f7;       /* purple-500 */
  --thumb-color: #7e22ce;       /* purple-700 */
  --thumb-hover: rgba(168,85,247,0.25); /* purple-500 with alpha */
}
`;
    document.head.appendChild(style);
  }

  const containers = document.querySelectorAll('.slider-range');
  containers.forEach(container => {
    const minInput = container.querySelector('[data-role="min"]');
    const maxInput = container.querySelector('[data-role="max"]');
    const rangeHighlight = container.querySelector('.slider-range__range');
    const display = document.querySelector(`[data-range-display="${container.dataset.rangeGroup}"]`);
    if (!minInput || !maxInput) return;

    const defaultMin = parseFloat(container.dataset.defaultMin ?? minInput.min ?? '0') || 0;
    const defaultMax = parseFloat(container.dataset.defaultMax ?? maxInput.max ?? '5') || 5;
    const minBound = parseFloat(minInput.min ?? defaultMin) || defaultMin;
    const maxBound = parseFloat(maxInput.max ?? defaultMax) || defaultMax;
    const precision = parseFloat(minInput.step || '0.1') || 0.1;

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
    const format = (value) => (Math.round(value / precision) * precision).toFixed(1);

    const updateTrack = (minVal, maxVal) => {
      if (!rangeHighlight) return;
      const span = maxBound - minBound || 1;
      const left = ((minVal - minBound) / span) * 100;
      const right = ((maxVal - minBound) / span) * 100;
      rangeHighlight.style.left = `${Math.max(0, Math.min(100, left))}%`;
      rangeHighlight.style.width = `${Math.max(0, Math.min(100, right) - Math.max(0, Math.min(100, left)))}%`;
    };

    const sync = (source) => {
      let minVal = parseFloat(minInput.value);
      let maxVal = parseFloat(maxInput.value);

      if (Number.isNaN(minVal)) minVal = defaultMin;
      if (Number.isNaN(maxVal)) maxVal = defaultMax;

      minVal = clamp(minVal, minBound, maxBound);
      maxVal = clamp(maxVal, minBound, maxBound);

      if (source === minInput && minVal > maxVal) {
        maxVal = minVal;
        maxInput.value = format(maxVal);
      }
      if (source === maxInput && maxVal < minVal) {
        minVal = maxVal;
        minInput.value = format(minVal);
      }

      minInput.value = format(minVal);
      maxInput.value = format(maxVal);

      if (display) {
        display.textContent = `${format(minVal)} – ${format(maxVal)}`;
      }

      updateTrack(minVal, maxVal);
    };

    sync();
    minInput.addEventListener('input', () => sync(minInput));
    maxInput.addEventListener('input', () => sync(maxInput));
  });
})();

(function () {
  const form = document.getElementById('filter-form');
  if (!form) return;
  const dateFields = Array.from(form.querySelectorAll('.filter-date-input'));
  const presetButtons = Array.from(document.querySelectorAll('#filter-overlay .date-preset'));
  const highlightClass = 'filter-date-input--active';

  const normalizeISO = (value) => {
    if (!value) return null;
    return /^\d{4}-\d{2}-\d{2}$/.test(value) ? value : null;
  };

  const updatePresetButtons = () => {
    presetButtons.forEach((btn) => btn.classList.remove('date-preset--active'));
    if (dateFields.length < 2) return;
    const from = normalizeISO(dateFields[0].value);
    const to = normalizeISO(dateFields[1].value);
    if (!from || !to) return;
    const today = new Date();
    const todayIso = today.toISOString().split('T')[0];

    const target = (preset) =>
      presetButtons.find((btn) => btn.dataset.preset === preset) || null;

    if (from === todayIso && to === todayIso) {
      const btn = target('today');
      btn?.classList.add('date-preset--active');
      return;
    }

    const toDate = new Date(`${to}T00:00:00`);
    const fromDate = new Date(`${from}T00:00:00`);
    if (Number.isNaN(toDate.getTime()) || Number.isNaN(fromDate.getTime())) return;
    const diffDays = Math.round((toDate.getTime() - fromDate.getTime()) / 86400000);
    const presets = {
      7: '7',
      14: '14',
      30: '30',
    };
    if (to === todayIso) {
      const key = presets[diffDays];
      if (key) {
        const btn = target(key);
        btn?.classList.add('date-preset--active');
      }
    }
  };

  const syncDateBorders = () => {
    dateFields.forEach((input) => {
      if (input.value) {
        input.classList.add(highlightClass);
      } else {
        input.classList.remove(highlightClass);
      }
    });
    updatePresetButtons();
  };

  dateFields.forEach((input) => {
    input.addEventListener('change', syncDateBorders);
    input.addEventListener('input', syncDateBorders);
  });

  syncDateBorders();
  window.__candidatesSyncDates = syncDateBorders;
})();

(function () {
  const resetButtons = document.querySelectorAll('.filter-reset-btn');
  resetButtons.forEach(btn => {
    const icon = btn.querySelector('svg');
    if (icon) {
      icon.style.transition = 'transform 0.2s ease';
    }
    btn.addEventListener('click', () => {
      if (icon) {
        icon.style.transform = 'rotate(45deg)';
        setTimeout(() => { icon.style.transform = 'rotate(0deg)'; }, 220);
      }
      const target = btn.dataset.resetUrl;
      if (target) {
        setTimeout(() => { window.location.href = target; }, 160);
      }
    });
  });
})();

(function () {
  const resetButton = document.getElementById('filters-reset');
  if (!resetButton) return;
  resetButton.addEventListener('click', (event) => {
    event.preventDefault();
    const target = resetButton.dataset.resetUrl;
    if (target) {
      window.location.href = target;
    }
  });
})();
</script>

{% endblock %}
